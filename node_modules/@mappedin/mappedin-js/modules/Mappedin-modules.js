import crypto from"crypto";import{DefaultLoadingManager,FileLoader,Group,BufferGeometry,BufferAttribute,MeshPhongMaterial,Mesh,Color,Loader,TextureLoader,EventDispatcher,FrontSide,RepeatWrapping,ClampToEdgeWrapping,DoubleSide}from"three";import*as three from"three";export{three as THREE};import{LatLonSpherical}from"geodesy";export{Easing,Tween}from"@tweenjs/tween.js";var results={RESULT:{SUCCESS:"success",FAILED_NO_WEB_GL:"failed_nowebgl",FAILED_NO_AA:"failed_noaa",FAILED_TOO_SLOW:"failed_tooslow",FAILED_TEXTURE_SIZE:"failed_texturesize"},NO_BENCHMARK:null};function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter((function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}))),keys.push.apply(keys,symbols)}return keys}function _objectSpread2(target){for(var i=1;i<arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{};i%2?ownKeys(source,!0).forEach((function(key){_defineProperty(target,key,source[key])})):Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):ownKeys(source).forEach((function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))}))}return target}function _slicedToArray(arr,i){return function(arr){if(Array.isArray(arr))return arr}(arr)||function(arr,i){if(!(Symbol.iterator in Object(arr)||"[object Arguments]"===Object.prototype.toString.call(arr)))return;var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var _isObject=function(it){return"object"==typeof it?null!==it:"function"==typeof it};function createCommonjsModule(fn,module){return fn(module={exports:{}},module.exports),module.exports}var id=0,px=Math.random(),_uid=function(key){return"Symbol(".concat(void 0===key?"":key,")_",(++id+px).toString(36))},hasOwnProperty={}.hasOwnProperty,_has=function(it,key){return hasOwnProperty.call(it,key)},_anObject=function(it){if(!_isObject(it))throw TypeError(it+" is not an object!");return it},_fails=function(exec){try{return!!exec()}catch(e){return!0}},_descriptors=!_fails((function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})),_global=createCommonjsModule((function(module){var global=module.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=global)})),document$1=_global.document,is=_isObject(document$1)&&_isObject(document$1.createElement),_domCreate=function(it){return is?document$1.createElement(it):{}},_ie8DomDefine=!_descriptors&&!_fails((function(){return 7!=Object.defineProperty(_domCreate("div"),"a",{get:function(){return 7}}).a})),_toPrimitive=function(it,S){if(!_isObject(it))return it;var fn,val;if(S&&"function"==typeof(fn=it.toString)&&!_isObject(val=fn.call(it)))return val;if("function"==typeof(fn=it.valueOf)&&!_isObject(val=fn.call(it)))return val;if(!S&&"function"==typeof(fn=it.toString)&&!_isObject(val=fn.call(it)))return val;throw TypeError("Can't convert object to primitive value")},dP=Object.defineProperty,_objectDp={f:_descriptors?Object.defineProperty:function(O,P,Attributes){if(_anObject(O),P=_toPrimitive(P,!0),_anObject(Attributes),_ie8DomDefine)try{return dP(O,P,Attributes)}catch(e){}if("get"in Attributes||"set"in Attributes)throw TypeError("Accessors not supported!");return"value"in Attributes&&(O[P]=Attributes.value),O}},_meta=createCommonjsModule((function(module){var META=_uid("meta"),setDesc=_objectDp.f,id=0,isExtensible=Object.isExtensible||function(){return!0},FREEZE=!_fails((function(){return isExtensible(Object.preventExtensions({}))})),setMeta=function(it){setDesc(it,META,{value:{i:"O"+ ++id,w:{}}})},meta=module.exports={KEY:META,NEED:!1,fastKey:function(it,create){if(!_isObject(it))return"symbol"==typeof it?it:("string"==typeof it?"S":"P")+it;if(!_has(it,META)){if(!isExtensible(it))return"F";if(!create)return"E";setMeta(it)}return it[META].i},getWeak:function(it,create){if(!_has(it,META)){if(!isExtensible(it))return!0;if(!create)return!1;setMeta(it)}return it[META].w},onFreeze:function(it){return FREEZE&&meta.NEED&&isExtensible(it)&&!_has(it,META)&&setMeta(it),it}}})),_core=(_meta.KEY,_meta.NEED,_meta.fastKey,_meta.getWeak,_meta.onFreeze,createCommonjsModule((function(module){var core=module.exports={version:"2.6.10"};"number"==typeof __e&&(__e=core)}))),_propertyDesc=(_core.version,function(bitmap,value){return{enumerable:!(1&bitmap),configurable:!(2&bitmap),writable:!(4&bitmap),value:value}}),_hide=_descriptors?function(object,key,value){return _objectDp.f(object,key,_propertyDesc(1,value))}:function(object,key,value){return object[key]=value,object},_shared=createCommonjsModule((function(module){var store=_global["__core-js_shared__"]||(_global["__core-js_shared__"]={});(module.exports=function(key,value){return store[key]||(store[key]=void 0!==value?value:{})})("versions",[]).push({version:_core.version,mode:"global",copyright:"© 2019 Denis Pushkarev (zloirock.ru)"})})),_functionToString=_shared("native-function-to-string",Function.toString),_redefine=createCommonjsModule((function(module){var SRC=_uid("src"),TPL=(""+_functionToString).split("toString");_core.inspectSource=function(it){return _functionToString.call(it)},(module.exports=function(O,key,val,safe){var isFunction="function"==typeof val;isFunction&&(_has(val,"name")||_hide(val,"name",key)),O[key]!==val&&(isFunction&&(_has(val,SRC)||_hide(val,SRC,O[key]?""+O[key]:TPL.join(String(key)))),O===_global?O[key]=val:safe?O[key]?O[key]=val:_hide(O,key,val):(delete O[key],_hide(O,key,val)))})(Function.prototype,"toString",(function(){return"function"==typeof this&&this[SRC]||_functionToString.call(this)}))})),_aFunction=function(it){if("function"!=typeof it)throw TypeError(it+" is not a function!");return it},_ctx=function(fn,that,length){if(_aFunction(fn),void 0===that)return fn;switch(length){case 1:return function(a){return fn.call(that,a)};case 2:return function(a,b){return fn.call(that,a,b)};case 3:return function(a,b,c){return fn.call(that,a,b,c)}}return function(){return fn.apply(that,arguments)}},$export=function(type,name,source){var key,own,out,exp,IS_FORCED=type&$export.F,IS_GLOBAL=type&$export.G,IS_STATIC=type&$export.S,IS_PROTO=type&$export.P,IS_BIND=type&$export.B,target=IS_GLOBAL?_global:IS_STATIC?_global[name]||(_global[name]={}):(_global[name]||{}).prototype,exports=IS_GLOBAL?_core:_core[name]||(_core[name]={}),expProto=exports.prototype||(exports.prototype={});for(key in IS_GLOBAL&&(source=name),source)out=((own=!IS_FORCED&&target&&void 0!==target[key])?target:source)[key],exp=IS_BIND&&own?_ctx(out,_global):IS_PROTO&&"function"==typeof out?_ctx(Function.call,out):out,target&&_redefine(target,key,out,type&$export.U),exports[key]!=out&&_hide(exports,key,exp),IS_PROTO&&expProto[key]!=out&&(expProto[key]=out)};_global.core=_core,$export.F=1,$export.G=2,$export.S=4,$export.P=8,$export.B=16,$export.W=32,$export.U=64,$export.R=128;var _export=$export,_objectSap=function(KEY,exec){var fn=(_core.Object||{})[KEY]||Object[KEY],exp={};exp[KEY]=exec(fn),_export(_export.S+_export.F*_fails((function(){fn(1)})),"Object",exp)},meta=_meta.onFreeze;_objectSap("freeze",(function($freeze){return function(it){return $freeze&&_isObject(it)?$freeze(meta(it)):it}}));var defer,channel,port,toString={}.toString,_cof=function(it){return toString.call(it).slice(8,-1)},_wks=createCommonjsModule((function(module){var store=_shared("wks"),Symbol=_global.Symbol,USE_SYMBOL="function"==typeof Symbol;(module.exports=function(name){return store[name]||(store[name]=USE_SYMBOL&&Symbol[name]||(USE_SYMBOL?Symbol:_uid)("Symbol."+name))}).store=store})),TAG=_wks("toStringTag"),ARG="Arguments"==_cof(function(){return arguments}()),_classof=function(it){var O,T,B;return void 0===it?"Undefined":null===it?"Null":"string"==typeof(T=function(it,key){try{return it[key]}catch(e){}}(O=Object(it),TAG))?T:ARG?_cof(O):"Object"==(B=_cof(O))&&"function"==typeof O.callee?"Arguments":B},_anInstance=function(it,Constructor,name,forbiddenField){if(!(it instanceof Constructor)||void 0!==forbiddenField&&forbiddenField in it)throw TypeError(name+": incorrect invocation!");return it},_iterCall=function(iterator,fn,value,entries){try{return entries?fn(_anObject(value)[0],value[1]):fn(value)}catch(e){var ret=iterator.return;throw void 0!==ret&&_anObject(ret.call(iterator)),e}},_iterators={},ITERATOR=_wks("iterator"),ArrayProto=Array.prototype,_isArrayIter=function(it){return void 0!==it&&(_iterators.Array===it||ArrayProto[ITERATOR]===it)},ceil=Math.ceil,floor=Math.floor,_toInteger=function(it){return isNaN(it=+it)?0:(it>0?floor:ceil)(it)},min=Math.min,_toLength=function(it){return it>0?min(_toInteger(it),9007199254740991):0},ITERATOR$1=_wks("iterator"),core_getIteratorMethod=_core.getIteratorMethod=function(it){if(null!=it)return it[ITERATOR$1]||it["@@iterator"]||_iterators[_classof(it)]},_forOf=createCommonjsModule((function(module){var BREAK={},RETURN={},exports=module.exports=function(iterable,entries,fn,that,ITERATOR){var length,step,iterator,result,iterFn=ITERATOR?function(){return iterable}:core_getIteratorMethod(iterable),f=_ctx(fn,that,entries?2:1),index=0;if("function"!=typeof iterFn)throw TypeError(iterable+" is not iterable!");if(_isArrayIter(iterFn)){for(length=_toLength(iterable.length);length>index;index++)if((result=entries?f(_anObject(step=iterable[index])[0],step[1]):f(iterable[index]))===BREAK||result===RETURN)return result}else for(iterator=iterFn.call(iterable);!(step=iterator.next()).done;)if((result=_iterCall(iterator,f,step.value,entries))===BREAK||result===RETURN)return result};exports.BREAK=BREAK,exports.RETURN=RETURN})),SPECIES=_wks("species"),_speciesConstructor=function(O,D){var S,C=_anObject(O).constructor;return void 0===C||null==(S=_anObject(C)[SPECIES])?D:_aFunction(S)},_invoke=function(fn,args,that){var un=void 0===that;switch(args.length){case 0:return un?fn():fn.call(that);case 1:return un?fn(args[0]):fn.call(that,args[0]);case 2:return un?fn(args[0],args[1]):fn.call(that,args[0],args[1]);case 3:return un?fn(args[0],args[1],args[2]):fn.call(that,args[0],args[1],args[2]);case 4:return un?fn(args[0],args[1],args[2],args[3]):fn.call(that,args[0],args[1],args[2],args[3])}return fn.apply(that,args)},document$2=_global.document,_html=document$2&&document$2.documentElement,process=_global.process,setTask=_global.setImmediate,clearTask=_global.clearImmediate,MessageChannel=_global.MessageChannel,Dispatch=_global.Dispatch,counter=0,queue={},run=function(){var id=+this;if(queue.hasOwnProperty(id)){var fn=queue[id];delete queue[id],fn()}},listener=function(event){run.call(event.data)};setTask&&clearTask||(setTask=function(fn){for(var args=[],i=1;arguments.length>i;)args.push(arguments[i++]);return queue[++counter]=function(){_invoke("function"==typeof fn?fn:Function(fn),args)},defer(counter),counter},clearTask=function(id){delete queue[id]},"process"==_cof(process)?defer=function(id){process.nextTick(_ctx(run,id,1))}:Dispatch&&Dispatch.now?defer=function(id){Dispatch.now(_ctx(run,id,1))}:MessageChannel?(port=(channel=new MessageChannel).port2,channel.port1.onmessage=listener,defer=_ctx(port.postMessage,port,1)):_global.addEventListener&&"function"==typeof postMessage&&!_global.importScripts?(defer=function(id){_global.postMessage(id+"","*")},_global.addEventListener("message",listener,!1)):defer="onreadystatechange"in _domCreate("script")?function(id){_html.appendChild(_domCreate("script")).onreadystatechange=function(){_html.removeChild(this),run.call(id)}}:function(id){setTimeout(_ctx(run,id,1),0)});var _task={set:setTask,clear:clearTask},macrotask=_task.set,Observer=_global.MutationObserver||_global.WebKitMutationObserver,process$1=_global.process,Promise$1=_global.Promise,isNode="process"==_cof(process$1);function PromiseCapability(C){var resolve,reject;this.promise=new C((function($$resolve,$$reject){if(void 0!==resolve||void 0!==reject)throw TypeError("Bad Promise constructor");resolve=$$resolve,reject=$$reject})),this.resolve=_aFunction(resolve),this.reject=_aFunction(reject)}var _newPromiseCapability={f:function(C){return new PromiseCapability(C)}},_perform=function(exec){try{return{e:!1,v:exec()}}catch(e){return{e:!0,v:e}}},navigator$1=_global.navigator,_userAgent=navigator$1&&navigator$1.userAgent||"",_redefineAll=function(target,src,safe){for(var key in src)_redefine(target,key,src[key],safe);return target},def=_objectDp.f,TAG$1=_wks("toStringTag"),_setToStringTag=function(it,tag,stat){it&&!_has(it=stat?it:it.prototype,TAG$1)&&def(it,TAG$1,{configurable:!0,value:tag})},SPECIES$1=_wks("species"),_setSpecies=function(KEY){var C=_global[KEY];_descriptors&&C&&!C[SPECIES$1]&&_objectDp.f(C,SPECIES$1,{configurable:!0,get:function(){return this}})},ITERATOR$2=_wks("iterator"),SAFE_CLOSING=!1;try{var riter=[7][ITERATOR$2]();riter.return=function(){SAFE_CLOSING=!0},Array.from(riter,(function(){throw 2}))}catch(e){}var Internal,newGenericPromiseCapability,OwnPromiseCapability,Wrapper,_iterDetect=function(exec,skipClosing){if(!skipClosing&&!SAFE_CLOSING)return!1;var safe=!1;try{var arr=[7],iter=arr[ITERATOR$2]();iter.next=function(){return{done:safe=!0}},arr[ITERATOR$2]=function(){return iter},exec(arr)}catch(e){}return safe},task=_task.set,microtask=function(){var head,last,notify,flush=function(){var parent,fn;for(isNode&&(parent=process$1.domain)&&parent.exit();head;){fn=head.fn,head=head.next;try{fn()}catch(e){throw head?notify():last=void 0,e}}last=void 0,parent&&parent.enter()};if(isNode)notify=function(){process$1.nextTick(flush)};else if(!Observer||_global.navigator&&_global.navigator.standalone)if(Promise$1&&Promise$1.resolve){var promise=Promise$1.resolve(void 0);notify=function(){promise.then(flush)}}else notify=function(){macrotask.call(_global,flush)};else{var toggle=!0,node=document.createTextNode("");new Observer(flush).observe(node,{characterData:!0}),notify=function(){node.data=toggle=!toggle}}return function(fn){var task={fn:fn,next:void 0};last&&(last.next=task),head||(head=task,notify()),last=task}}(),TypeError$1=_global.TypeError,process$2=_global.process,versions=process$2&&process$2.versions,v8=versions&&versions.v8||"",$Promise=_global.Promise,isNode$1="process"==_classof(process$2),empty=function(){},newPromiseCapability=newGenericPromiseCapability=_newPromiseCapability.f,USE_NATIVE=!!function(){try{var promise=$Promise.resolve(1),FakePromise=(promise.constructor={})[_wks("species")]=function(exec){exec(empty,empty)};return(isNode$1||"function"==typeof PromiseRejectionEvent)&&promise.then(empty)instanceof FakePromise&&0!==v8.indexOf("6.6")&&-1===_userAgent.indexOf("Chrome/66")}catch(e){}}(),isThenable=function(it){var then;return!(!_isObject(it)||"function"!=typeof(then=it.then))&&then},notify=function(promise,isReject){if(!promise._n){promise._n=!0;var chain=promise._c;microtask((function(){for(var value=promise._v,ok=1==promise._s,i=0,run=function(reaction){var result,then,exited,handler=ok?reaction.ok:reaction.fail,resolve=reaction.resolve,reject=reaction.reject,domain=reaction.domain;try{handler?(ok||(2==promise._h&&onHandleUnhandled(promise),promise._h=1),!0===handler?result=value:(domain&&domain.enter(),result=handler(value),domain&&(domain.exit(),exited=!0)),result===reaction.promise?reject(TypeError$1("Promise-chain cycle")):(then=isThenable(result))?then.call(result,resolve,reject):resolve(result)):reject(value)}catch(e){domain&&!exited&&domain.exit(),reject(e)}};chain.length>i;)run(chain[i++]);promise._c=[],promise._n=!1,isReject&&!promise._h&&onUnhandled(promise)}))}},onUnhandled=function(promise){task.call(_global,(function(){var result,handler,console,value=promise._v,unhandled=isUnhandled(promise);if(unhandled&&(result=_perform((function(){isNode$1?process$2.emit("unhandledRejection",value,promise):(handler=_global.onunhandledrejection)?handler({promise:promise,reason:value}):(console=_global.console)&&console.error&&console.error("Unhandled promise rejection",value)})),promise._h=isNode$1||isUnhandled(promise)?2:1),promise._a=void 0,unhandled&&result.e)throw result.v}))},isUnhandled=function(promise){return 1!==promise._h&&0===(promise._a||promise._c).length},onHandleUnhandled=function(promise){task.call(_global,(function(){var handler;isNode$1?process$2.emit("rejectionHandled",promise):(handler=_global.onrejectionhandled)&&handler({promise:promise,reason:promise._v})}))},$reject=function(value){var promise=this;promise._d||(promise._d=!0,(promise=promise._w||promise)._v=value,promise._s=2,promise._a||(promise._a=promise._c.slice()),notify(promise,!0))},$resolve=function(value){var then,promise=this;if(!promise._d){promise._d=!0,promise=promise._w||promise;try{if(promise===value)throw TypeError$1("Promise can't be resolved itself");(then=isThenable(value))?microtask((function(){var wrapper={_w:promise,_d:!1};try{then.call(value,_ctx($resolve,wrapper,1),_ctx($reject,wrapper,1))}catch(e){$reject.call(wrapper,e)}})):(promise._v=value,promise._s=1,notify(promise,!1))}catch(e){$reject.call({_w:promise,_d:!1},e)}}};USE_NATIVE||($Promise=function(executor){_anInstance(this,$Promise,"Promise","_h"),_aFunction(executor),Internal.call(this);try{executor(_ctx($resolve,this,1),_ctx($reject,this,1))}catch(err){$reject.call(this,err)}},(Internal=function(executor){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1}).prototype=_redefineAll($Promise.prototype,{then:function(onFulfilled,onRejected){var reaction=newPromiseCapability(_speciesConstructor(this,$Promise));return reaction.ok="function"!=typeof onFulfilled||onFulfilled,reaction.fail="function"==typeof onRejected&&onRejected,reaction.domain=isNode$1?process$2.domain:void 0,this._c.push(reaction),this._a&&this._a.push(reaction),this._s&&notify(this,!1),reaction.promise},catch:function(onRejected){return this.then(void 0,onRejected)}}),OwnPromiseCapability=function(){var promise=new Internal;this.promise=promise,this.resolve=_ctx($resolve,promise,1),this.reject=_ctx($reject,promise,1)},_newPromiseCapability.f=newPromiseCapability=function(C){return C===$Promise||C===Wrapper?new OwnPromiseCapability(C):newGenericPromiseCapability(C)}),_export(_export.G+_export.W+_export.F*!USE_NATIVE,{Promise:$Promise}),_setToStringTag($Promise,"Promise"),_setSpecies("Promise"),Wrapper=_core.Promise,_export(_export.S+_export.F*!USE_NATIVE,"Promise",{reject:function(r){var capability=newPromiseCapability(this);return(0,capability.reject)(r),capability.promise}}),_export(_export.S+_export.F*!USE_NATIVE,"Promise",{resolve:function(x){return function(C,x){if(_anObject(C),_isObject(x)&&x.constructor===C)return x;var promiseCapability=_newPromiseCapability.f(C);return(0,promiseCapability.resolve)(x),promiseCapability.promise}(this,x)}}),_export(_export.S+_export.F*!(USE_NATIVE&&_iterDetect((function(iter){$Promise.all(iter).catch(empty)}))),"Promise",{all:function(iterable){var C=this,capability=newPromiseCapability(C),resolve=capability.resolve,reject=capability.reject,result=_perform((function(){var values=[],index=0,remaining=1;_forOf(iterable,!1,(function(promise){var $index=index++,alreadyCalled=!1;values.push(void 0),remaining++,C.resolve(promise).then((function(value){alreadyCalled||(alreadyCalled=!0,values[$index]=value,--remaining||resolve(values))}),reject)})),--remaining||resolve(values)}));return result.e&&reject(result.v),capability.promise},race:function(iterable){var C=this,capability=newPromiseCapability(C),reject=capability.reject,result=_perform((function(){_forOf(iterable,!1,(function(promise){C.resolve(promise).then(capability.resolve,reject)}))}));return result.e&&reject(result.v),capability.promise}});var dP$1=_objectDp.f,FProto=Function.prototype,nameRE=/^\s*function ([^ (]*)/;"name"in FProto||_descriptors&&dP$1(FProto,"name",{configurable:!0,get:function(){try{return(""+this).match(nameRE)[1]}catch(e){return""}}});var _iobject=Object("z").propertyIsEnumerable(0)?Object:function(it){return"String"==_cof(it)?it.split(""):Object(it)},_defined=function(it){if(null==it)throw TypeError("Can't call method on  "+it);return it},_toIobject=function(it){return _iobject(_defined(it))},max=Math.max,min$1=Math.min,_toAbsoluteIndex=function(index,length){return(index=_toInteger(index))<0?max(index+length,0):min$1(index,length)},_arrayIncludes=function(IS_INCLUDES){return function($this,el,fromIndex){var value,O=_toIobject($this),length=_toLength(O.length),index=_toAbsoluteIndex(fromIndex,length);if(IS_INCLUDES&&el!=el){for(;length>index;)if((value=O[index++])!=value)return!0}else for(;length>index;index++)if((IS_INCLUDES||index in O)&&O[index]===el)return IS_INCLUDES||index||0;return!IS_INCLUDES&&-1}},UNSCOPABLES=_wks("unscopables"),ArrayProto$1=Array.prototype;null==ArrayProto$1[UNSCOPABLES]&&_hide(ArrayProto$1,UNSCOPABLES,{});var _addToUnscopables=function(key){ArrayProto$1[UNSCOPABLES][key]=!0},$includes=_arrayIncludes(!0);_export(_export.P,"Array",{includes:function(el){return $includes(this,el,arguments.length>1?arguments[1]:void 0)}}),_addToUnscopables("includes");var MATCH=_wks("match"),_isRegexp=function(it){var isRegExp;return _isObject(it)&&(void 0!==(isRegExp=it[MATCH])?!!isRegExp:"RegExp"==_cof(it))},_stringContext=function(that,searchString,NAME){if(_isRegexp(searchString))throw TypeError("String#"+NAME+" doesn't accept regex!");return String(_defined(that))},MATCH$1=_wks("match"),_failsIsRegexp=function(KEY){var re=/./;try{"/./"[KEY](re)}catch(e){try{return re[MATCH$1]=!1,!"/./"[KEY](re)}catch(f){}}return!0};_export(_export.P+_export.F*_failsIsRegexp("includes"),"String",{includes:function(searchString){return!!~_stringContext(this,searchString,"includes").indexOf(searchString,arguments.length>1?arguments[1]:void 0)}});var method,arg,_toObject=function(it){return Object(_defined(it))},$sort=[].sort,test=[1,2,3];_export(_export.P+_export.F*(_fails((function(){test.sort(void 0)}))||!_fails((function(){test.sort(null)}))||!((method=$sort)&&_fails((function(){arg?method.call(null,(function(){}),1):method.call(null)})))),"Array",{sort:function(comparefn){return void 0===comparefn?$sort.call(_toObject(this)):$sort.call(_toObject(this),_aFunction(comparefn))}});var _objectPie={f:{}.propertyIsEnumerable},gOPD=Object.getOwnPropertyDescriptor,_objectGopd={f:_descriptors?gOPD:function(O,P){if(O=_toIobject(O),P=_toPrimitive(P,!0),_ie8DomDefine)try{return gOPD(O,P)}catch(e){}if(_has(O,P))return _propertyDesc(!_objectPie.f.call(O,P),O[P])}},check=function(O,proto){if(_anObject(O),!_isObject(proto)&&null!==proto)throw TypeError(proto+": can't set as prototype!")},setPrototypeOf={set:Object.setPrototypeOf||("__proto__"in{}?function(test,buggy,set){try{(set=_ctx(Function.call,_objectGopd.f(Object.prototype,"__proto__").set,2))(test,[]),buggy=!(test instanceof Array)}catch(e){buggy=!0}return function(O,proto){return check(O,proto),buggy?O.__proto__=proto:set(O,proto),O}}({},!1):void 0),check:check}.set,_inheritIfRequired=function(that,target,C){var P,S=target.constructor;return S!==C&&"function"==typeof S&&(P=S.prototype)!==C.prototype&&_isObject(P)&&setPrototypeOf&&setPrototypeOf(that,P),that},shared=_shared("keys"),_sharedKey=function(key){return shared[key]||(shared[key]=_uid(key))},arrayIndexOf=_arrayIncludes(!1),IE_PROTO=_sharedKey("IE_PROTO"),_objectKeysInternal=function(object,names){var key,O=_toIobject(object),i=0,result=[];for(key in O)key!=IE_PROTO&&_has(O,key)&&result.push(key);for(;names.length>i;)_has(O,key=names[i++])&&(~arrayIndexOf(result,key)||result.push(key));return result},_enumBugKeys="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(","),hiddenKeys=_enumBugKeys.concat("length","prototype"),_objectGopn={f:Object.getOwnPropertyNames||function(O){return _objectKeysInternal(O,hiddenKeys)}},_stringWs="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff",space="["+_stringWs+"]",ltrim=RegExp("^"+space+space+"*"),rtrim=RegExp(space+space+"*$"),exporter=function(KEY,exec,ALIAS){var exp={},FORCE=_fails((function(){return!!_stringWs[KEY]()||"​"!="​"[KEY]()})),fn=exp[KEY]=FORCE?exec(trim):_stringWs[KEY];ALIAS&&(exp[ALIAS]=fn),_export(_export.P+_export.F*FORCE,"String",exp)},trim=exporter.trim=function(string,TYPE){return string=String(_defined(string)),1&TYPE&&(string=string.replace(ltrim,"")),2&TYPE&&(string=string.replace(rtrim,"")),string},_stringTrim=exporter,_objectKeys=Object.keys||function(O){return _objectKeysInternal(O,_enumBugKeys)},_objectDps=_descriptors?Object.defineProperties:function(O,Properties){_anObject(O);for(var P,keys=_objectKeys(Properties),length=keys.length,i=0;length>i;)_objectDp.f(O,P=keys[i++],Properties[P]);return O},IE_PROTO$1=_sharedKey("IE_PROTO"),Empty=function(){},createDict=function(){var iframeDocument,iframe=_domCreate("iframe"),i=_enumBugKeys.length;for(iframe.style.display="none",_html.appendChild(iframe),iframe.src="javascript:",(iframeDocument=iframe.contentWindow.document).open(),iframeDocument.write("<script>document.F=Object<\/script>"),iframeDocument.close(),createDict=iframeDocument.F;i--;)delete createDict.prototype[_enumBugKeys[i]];return createDict()},_objectCreate=Object.create||function(O,Properties){var result;return null!==O?(Empty.prototype=_anObject(O),result=new Empty,Empty.prototype=null,result[IE_PROTO$1]=O):result=createDict(),void 0===Properties?result:_objectDps(result,Properties)},gOPN=_objectGopn.f,gOPD$1=_objectGopd.f,dP$2=_objectDp.f,$trim=_stringTrim.trim,$Number=_global.Number,Base=$Number,proto=$Number.prototype,BROKEN_COF="Number"==_cof(_objectCreate(proto)),TRIM="trim"in String.prototype,toNumber=function(argument){var it=_toPrimitive(argument,!1);if("string"==typeof it&&it.length>2){var third,radix,maxCode,first=(it=TRIM?it.trim():$trim(it,3)).charCodeAt(0);if(43===first||45===first){if(88===(third=it.charCodeAt(2))||120===third)return NaN}else if(48===first){switch(it.charCodeAt(1)){case 66:case 98:radix=2,maxCode=49;break;case 79:case 111:radix=8,maxCode=55;break;default:return+it}for(var code,digits=it.slice(2),i=0,l=digits.length;i<l;i++)if((code=digits.charCodeAt(i))<48||code>maxCode)return NaN;return parseInt(digits,radix)}}return+it};if(!$Number(" 0o1")||!$Number("0b1")||$Number("+0x1")){$Number=function(value){var it=arguments.length<1?0:value,that=this;return that instanceof $Number&&(BROKEN_COF?_fails((function(){proto.valueOf.call(that)})):"Number"!=_cof(that))?_inheritIfRequired(new Base(toNumber(it)),that,$Number):toNumber(it)};for(var key,keys=_descriptors?gOPN(Base):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","),j=0;keys.length>j;j++)_has(Base,key=keys[j])&&!_has($Number,key)&&dP$2($Number,key,gOPD$1(Base,key));$Number.prototype=proto,proto.constructor=$Number,_redefine(_global,"Number",$Number)}var _isArray=Array.isArray||function(arg){return"Array"==_cof(arg)},SPECIES$2=_wks("species"),_arraySpeciesCreate=function(original,length){return new(function(original){var C;return _isArray(original)&&("function"!=typeof(C=original.constructor)||C!==Array&&!_isArray(C.prototype)||(C=void 0),_isObject(C)&&null===(C=C[SPECIES$2])&&(C=void 0)),void 0===C?Array:C}(original))(length)},_arrayMethods=function(TYPE,$create){var IS_MAP=1==TYPE,IS_FILTER=2==TYPE,IS_SOME=3==TYPE,IS_EVERY=4==TYPE,IS_FIND_INDEX=6==TYPE,NO_HOLES=5==TYPE||IS_FIND_INDEX,create=$create||_arraySpeciesCreate;return function($this,callbackfn,that){for(var val,res,O=_toObject($this),self=_iobject(O),f=_ctx(callbackfn,that,3),length=_toLength(self.length),index=0,result=IS_MAP?create($this,length):IS_FILTER?create($this,0):void 0;length>index;index++)if((NO_HOLES||index in self)&&(res=f(val=self[index],index,O),TYPE))if(IS_MAP)result[index]=res;else if(res)switch(TYPE){case 3:return!0;case 5:return val;case 6:return index;case 2:result.push(val)}else if(IS_EVERY)return!1;return IS_FIND_INDEX?-1:IS_SOME||IS_EVERY?IS_EVERY:result}},$find=_arrayMethods(5),forced=!0;"find"in[]&&Array(1).find((function(){forced=!1})),_export(_export.P+_export.F*forced,"Array",{find:function(callbackfn){return $find(this,callbackfn,arguments.length>1?arguments[1]:void 0)}}),_addToUnscopables("find");var _iterStep=function(done,value){return{value:value,done:!!done}},IteratorPrototype={};_hide(IteratorPrototype,_wks("iterator"),(function(){return this}));var _iterCreate=function(Constructor,NAME,next){Constructor.prototype=_objectCreate(IteratorPrototype,{next:_propertyDesc(1,next)}),_setToStringTag(Constructor,NAME+" Iterator")},IE_PROTO$2=_sharedKey("IE_PROTO"),ObjectProto=Object.prototype,_objectGpo=Object.getPrototypeOf||function(O){return O=_toObject(O),_has(O,IE_PROTO$2)?O[IE_PROTO$2]:"function"==typeof O.constructor&&O instanceof O.constructor?O.constructor.prototype:O instanceof Object?ObjectProto:null},ITERATOR$3=_wks("iterator"),BUGGY=!([].keys&&"next"in[].keys()),returnThis=function(){return this},_iterDefine=function(Base,NAME,Constructor,next,DEFAULT,IS_SET,FORCED){_iterCreate(Constructor,NAME,next);var methods,key,IteratorPrototype,getMethod=function(kind){if(!BUGGY&&kind in proto)return proto[kind];switch(kind){case"keys":case"values":return function(){return new Constructor(this,kind)}}return function(){return new Constructor(this,kind)}},TAG=NAME+" Iterator",DEF_VALUES="values"==DEFAULT,VALUES_BUG=!1,proto=Base.prototype,$native=proto[ITERATOR$3]||proto["@@iterator"]||DEFAULT&&proto[DEFAULT],$default=$native||getMethod(DEFAULT),$entries=DEFAULT?DEF_VALUES?getMethod("entries"):$default:void 0,$anyNative="Array"==NAME&&proto.entries||$native;if($anyNative&&(IteratorPrototype=_objectGpo($anyNative.call(new Base)))!==Object.prototype&&IteratorPrototype.next&&(_setToStringTag(IteratorPrototype,TAG,!0),"function"!=typeof IteratorPrototype[ITERATOR$3]&&_hide(IteratorPrototype,ITERATOR$3,returnThis)),DEF_VALUES&&$native&&"values"!==$native.name&&(VALUES_BUG=!0,$default=function(){return $native.call(this)}),(BUGGY||VALUES_BUG||!proto[ITERATOR$3])&&_hide(proto,ITERATOR$3,$default),_iterators[NAME]=$default,_iterators[TAG]=returnThis,DEFAULT)if(methods={values:DEF_VALUES?$default:getMethod("values"),keys:IS_SET?$default:getMethod("keys"),entries:$entries},FORCED)for(key in methods)key in proto||_redefine(proto,key,methods[key]);else _export(_export.P+_export.F*(BUGGY||VALUES_BUG),NAME,methods);return methods},es6_array_iterator=_iterDefine(Array,"Array",(function(iterated,kind){this._t=_toIobject(iterated),this._i=0,this._k=kind}),(function(){var O=this._t,kind=this._k,index=this._i++;return!O||index>=O.length?(this._t=void 0,_iterStep(1)):_iterStep(0,"keys"==kind?index:"values"==kind?O[index]:[index,O[index]])}),"values");_iterators.Arguments=_iterators.Array,_addToUnscopables("keys"),_addToUnscopables("values"),_addToUnscopables("entries");for(var ITERATOR$4=_wks("iterator"),TO_STRING_TAG=_wks("toStringTag"),ArrayValues=_iterators.Array,DOMIterables={CSSRuleList:!0,CSSStyleDeclaration:!1,CSSValueList:!1,ClientRectList:!1,DOMRectList:!1,DOMStringList:!1,DOMTokenList:!0,DataTransferItemList:!1,FileList:!1,HTMLAllCollection:!1,HTMLCollection:!1,HTMLFormElement:!1,HTMLSelectElement:!1,MediaList:!0,MimeTypeArray:!1,NamedNodeMap:!1,NodeList:!0,PaintRequestList:!1,Plugin:!1,PluginArray:!1,SVGLengthList:!1,SVGNumberList:!1,SVGPathSegList:!1,SVGPointList:!1,SVGStringList:!1,SVGTransformList:!1,SourceBufferList:!1,StyleSheetList:!0,TextTrackCueList:!1,TextTrackList:!1,TouchList:!1},collections=_objectKeys(DOMIterables),i=0;i<collections.length;i++){var key$1,NAME$1=collections[i],explicit=DOMIterables[NAME$1],Collection=_global[NAME$1],proto$1=Collection&&Collection.prototype;if(proto$1&&(proto$1[ITERATOR$4]||_hide(proto$1,ITERATOR$4,ArrayValues),proto$1[TO_STRING_TAG]||_hide(proto$1,TO_STRING_TAG,NAME$1),_iterators[NAME$1]=ArrayValues,explicit))for(key$1 in es6_array_iterator)proto$1[key$1]||_redefine(proto$1,key$1,es6_array_iterator[key$1],!0)}var test$1={};test$1[_wks("toStringTag")]="z",test$1+""!="[object z]"&&_redefine(Object.prototype,"toString",(function(){return"[object "+_classof(this)+"]"}),!0),_objectSap("keys",(function(){return function(it){return _objectKeys(_toObject(it))}}));var quot=/"/g,createHTML=function(string,tag,attribute,value){var S=String(_defined(string)),p1="<"+tag;return""!==attribute&&(p1+=" "+attribute+'="'+String(value).replace(quot,"&quot;")+'"'),p1+">"+S+"</"+tag+">"};!function(NAME,exec){var O={};O[NAME]=exec(createHTML),_export(_export.P+_export.F*_fails((function(){var test=""[NAME]('"');return test!==test.toLowerCase()||test.split('"').length>3})),"String",O)}("sub",(function(createHTML){return function(){return createHTML(this,"sub","","")}}));var rb=crypto.randomBytes;for(var rng_1=function(){return rb(16)},byteToHex=[],i$1=0;i$1<256;++i$1)byteToHex[i$1]=(i$1+256).toString(16).substr(1);var bytesToUuid_1=function(buf,offset){var i=offset||0,bth=byteToHex;return bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]};var MI_UUID,MI_SESSION,v4_1=function(options,buf,offset){var i=buf&&offset||0;"string"==typeof options&&(buf="binary"==options?new Array(16):null,options=null);var rnds=(options=options||{}).random||(options.rng||rng_1)();if(rnds[6]=15&rnds[6]|64,rnds[8]=63&rnds[8]|128,buf)for(var ii=0;ii<16;++ii)buf[i+ii]=rnds[ii];return buf||bytesToUuid_1(rnds)};function isGatewayKey(key){return/^[\da-f]{24}$/i.test(key)}function getDeviceID(){if(!MI_UUID)try{(MI_UUID=localStorage.getItem("mi-uuid"))||(MI_UUID=v4_1(),localStorage.setItem("mi-uuid",MI_UUID))}catch(_){MI_UUID="NLS-"+v4_1()}return MI_UUID}function getSessionID(){if(!MI_SESSION)try{(MI_SESSION=sessionStorage.getItem("mi-session"))||(MI_SESSION=v4_1(),sessionStorage.setItem("mi-session",MI_SESSION))}catch(_){MI_SESSION="NSS-"+v4_1()}return MI_SESSION}function getObjectId(object){return"string"==typeof object?object:object.id}var DISTANT_PAST=0,FAR_FUTURE="9999-12-31T00:00:00.000Z";function addToSet(array,value){array.indexOf(value)<0&&array.push(value)}function assignMissing(target,source){for(var keys=Object.keys(source),i=0,iLen=keys.length;i<iLen;++i){var key=keys[i];key in target||(target[key]=source[key])}}function defineGetter(proto,name,getter){Object.defineProperty(proto.prototype,name,{configurable:!1,enumerable:!1,get:getter,set:void 0})}function defineLazyGetter(proto,name,enumerator){defineGetter(proto,name,(function(){var cache=this._cache[name];return void 0===cache&&(cache=this._cache[name]=enumerator.call(this)),cache}))}function MappedinCategory(mappedin,data){this._mappedin=mappedin,this._data=data,this._cache={},assignMissing(this,data)}function MappedinLocation(mappedin,data){this._mappedin=mappedin,this._data=data,this._cache={},assignMissing(this,data)}function MappedinVortex(mappedin,data){this._mappedin=mappedin,this._data=data,this._cache={},assignMissing(this,data)}function MappedinMapGroup(mappedin,data){this._mappedin=mappedin,this._data=data,this._cache={},assignMissing(this,data)}function MappedinMap(mappedin,data){this._mappedin=mappedin,this._data=data,this._cache={},this._scale=function(map){if(map.scale||map.x_scale)return 1/(map.scale||map.x_scale);var mapScale;try{var anchor1=map.georeference[0],anchor2=map.georeference[2],ll1=new LatLonSpherical(anchor1.target.x,anchor1.target.y),ll2=new LatLonSpherical(anchor2.target.x,anchor2.target.y),worldDistance=ll1.distanceTo(ll2),xDiff=anchor1.control.x-anchor2.control.x,yDiff=anchor1.control.y-anchor2.control.y;mapScale=Math.sqrt(xDiff*xDiff+yDiff*yDiff)/worldDistance}catch(e){mapScale=1,console.warn(e),console.warn("Couldn't georeference "+(map.name||map.shortName||map.id)+". Probably not enough geocoordinates.")}return mapScale}(this._data),assignMissing(this,data)}function MappedinNode(mappedin,data,index){this._mappedin=mappedin,this._data=data,this._index=index,this._cache={},assignMissing(this,data)}function directionsTo(mappedinData,start,departFrom,destination,options,cb){var directions,directionsOptions=options||{};null==mappedinData.venue.navigationGraph&&(mappedinData.venue.navigationGraph=new NavigationGraph(mappedinData.nodes,mappedinData.vortexes));var path,error,arriveAt,graph=mappedinData.venue.navigationGraph,accessible=directionsOptions.accessible||!1;destination instanceof MappedinLocation?(path=graph.aStar(start,destination.nodes,accessible),directions=new MappedinDirections(graph,path,departFrom,destination,mappedinData.nodes)):destination instanceof MappedinNode?(arriveAt=destination.locations.length>0?destination.locations[0]:null,path=graph.aStar(start,[destination],accessible),directions=new MappedinDirections(graph,path,departFrom,arriveAt,mappedinData.nodes)):destination instanceof MappedinPolygon?(path=graph.aStar(start,destination.entrances,accessible),directions=new MappedinDirections(graph,path,departFrom,arriveAt=destination.locations.length>0?destination.locations[0]:null,mappedinData.nodes)):destination instanceof Array&&destination.length>0&&destination[0]instanceof MappedinNode?(path=graph.aStar(start,destination,accessible),directions=new MappedinDirections(graph,path,departFrom,null,mappedinData.nodes)):error=new TypeError("destination must be a MappedinLocation, MappedinNode, MappedinPolygon or [MappedinNode]"),directions&&0==directions.path.length&&(error=new Error("could not find a path to destination")),cb(error,directions)}function distanceTo(graph,start,destination,options,cb){var path,error,accessible=(options||{}).accessible||!1;destination instanceof MappedinLocation?path=graph.aStar(start,destination.nodes,accessible):destination instanceof MappedinNode?path=graph.aStar(start,[destination],accessible):destination instanceof MappedinPolygon?path=graph.aStar(start,destination.entrances,accessible):destination instanceof Array&&destination.length>0&&destination[0]instanceof MappedinNode?path=graph.aStar(start,destination,accessible):error=new TypeError("destination must be a MappedinLocation, MappedinNode, MappedinPolygon or [MappedinNode]");var distance=0,cost=0;if(path&&path.length>0)for(var index=0;index<path.length;index++){var edge=path[index];distance+=edge.getDistance(),cost+=edge.weight*edge.getDistance()}else error=new Error("could not find a path to destination");cb(error,{cost:cost,distance:distance})}function Edge(origin,destination){var weight,multiplier,vortex=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(this.origin=origin,this.destination=destination,this.vortex=vortex,null!=vortex){var originElevation=origin._mappedin._mapsById[origin.map].elevation,destinationElevation=destination._mappedin._mapsById[destination.map].elevation,elevationDelta=Math.abs(originElevation-destinationElevation);this.distance=0,weight=void 0!==vortex.weight&&vortex.weight>0?vortex.weight:"elevator"===vortex.type?2e3:1e3,multiplier=vortex.multiplier&&vortex.multiplier>=1?vortex.multiplier:1,this.weight=elevationDelta*multiplier+weight}else this.distance=this.origin.getDistance(this.destination),weight=destination.weight&&destination.weight>=0?destination.weight:0,multiplier=destination.multiplier&&destination.multiplier>=1?destination.multiplier:1,this.weight=this.distance*multiplier+weight}function NavigationGraph(nodes,vortexes){var edges=[];nodes.forEach((function(origin){edges[origin._index]=[];for(var pathLength=origin.paths.length,destinations=origin.paths,j=0;j<pathLength;j++){var destination=destinations[j];edges[origin._index].push(new Edge(origin,destination))}})),vortexes.forEach((function(vortex){var vortexNodes=vortex.nodes,originIndex=0;if(null!=vortexNodes)for(;originIndex<vortexNodes.length-1;){var origin=vortex._mappedin._nodesById[vortexNodes[originIndex]];if(null!=origin)for(var destinationIndex=originIndex+1;destinationIndex<vortexNodes.length;){var destination=vortex._mappedin._nodesById[vortexNodes[destinationIndex]];null!=destination&&(edges[origin._index].push(new Edge(origin,destination,vortex)),edges[destination._index].push(new Edge(destination,origin,vortex))),destinationIndex++}originIndex++}})),this.edges=edges}function MappedinDirections(graph,steps,departFrom,arriveAt,venueNodes){if(null!=steps&&steps.length>0){for(var distance=0,stepsLength=steps.length,path=new Array(stepsLength+1),i=0;i<stepsLength;i++)path[i]=steps[i].origin;path[stepsLength]=steps[stepsLength-1].destination;for(var instructions=[],prevNode=null,prevEdge=null,index=0;index<stepsLength;index++){var instruction,edge=steps[index],origin=edge.origin,destination=edge.destination;if(distance+=edge.getDistance(),0==index&&(instruction=null!=departFrom?"Depart from "+departFrom.name:"Depart from current location",instructions.push(new MappedinDirective(origin,{type:actionType.DEPARTURE},departFrom,instruction))),null!=edge.vortex){var fromMap=origin._mappedin._mapsById[origin.map],toMap=origin._mappedin._mapsById[destination.map];instruction="Take "+edge.vortex.name+" to "+toMap.name,instructions.push(new MappedinDirective(origin,{type:actionType.TAKEVORTEX,fromMap:fromMap,toMap:toMap},edge.vortex,instruction))}else{var bearingChangeThreshold=.1*Math.PI;if(null!=prevNode&&null!=prevEdge){for(var exits=graph.edges[origin._index],otherExits=[],j=0;j<exits.length;j++){var otherExit=exits[j];otherExit.destination!=prevNode&&otherExit.destination!=edge.destination&&otherExits.push(otherExit)}if(otherExits.length>0){for(var relativeBearingAngle=-differenceBetweenAngles(prevEdge.getAngle(),edge.getAngle()),closestOptionDelta=Math.PI,k=0;k<otherExits.length;k++){var exit=otherExits[k],newDelta=-differenceBetweenAngles(edge.getAngle(),exit.getAngle());closestOptionDelta=Math.min(closestOptionDelta,Math.abs(newDelta))}if(null!=prevEdge.vortex)instruction="Exit out of "+prevEdge.vortex.type,instructions.push(new MappedinDirective(origin,{type:actionType.TURN,bearing:"Straight",referencePosition:"At"},prevEdge.vortex,instruction));else if(Math.abs(relativeBearingAngle)>=bearingChangeThreshold||Math.abs(closestOptionDelta)<=bearingChangeThreshold){var relativeBearing,relativeBearingString;relativeBearingAngle<=-Math.PI/4?(relativeBearing=bearingType.RIGHT,relativeBearingString="Turn right"):relativeBearingAngle<=-bearingChangeThreshold?(relativeBearing=bearingType.SLIGHTRIGHT,relativeBearingString="Turn slightly right"):relativeBearingAngle<=bearingChangeThreshold?(relativeBearing=bearingType.STRAIGHT,relativeBearingString="Head straight"):relativeBearingAngle<=Math.PI/4?(relativeBearing=bearingType.SLIGHTLEFT,relativeBearingString="Turn slightly left"):(relativeBearing=bearingType.LEFT,relativeBearingString="Turn left");var referenceLocation=null;if(null!=(referenceLocation=venueNodes.includes(origin)&&null!=origin.locations[0]?origin.locations[0]:getClosestLocationInRay(graph,prevEdge,.5*Math.PI,10))){var instructionString=relativeBearingString+" at "+referenceLocation.name;(instruction=new MappedinDirective(origin,{type:actionType.TURN,bearing:relativeBearing,referencePosition:"At"},referenceLocation,instructionString)).type=relativeBearing,instructions.push(instruction)}else instruction=new MappedinDirective(origin,{type:actionType.TURN,bearing:relativeBearing,referencePosition:"At"},null,relativeBearingString),instructions.push(instruction)}}}}index==stepsLength-1&&(instruction=null!=arriveAt?"Arrive at "+arriveAt.name:"Arrive at destination",instructions.push(new MappedinDirective(origin,{type:actionType.ARRIVAL},arriveAt,instruction))),prevNode=origin,prevEdge=edge}for(var filteredInstructions=[],previousVortex=null,l=instructions.length-1;l>=0;l--){var filteredInstruction=instructions[l];filteredInstruction.action.type==actionType.TAKEVORTEX?(previousVortex=filteredInstruction.node,filteredInstructions.unshift(filteredInstruction)):filteredInstruction.action.type==actionType.TURN&&null!=previousVortex?filteredInstruction.node.getDistance(previousVortex)>5&&filteredInstructions.unshift(filteredInstruction):filteredInstructions.unshift(filteredInstruction)}this.distance=distance,this.path=path,this.instructions=filteredInstructions,this.directions=filteredInstructions}else this.distance=0,this.path=[],this.instructions=[],this.directions=filteredInstructions}function getClosestLocationInRay(graph,startingEdge,angleThreshold,distanceThreshold){for(var totalAngle=0,totalDistance=0,currentEdge=startingEdge;Math.abs(totalAngle)<angleThreshold&&totalDistance<distanceThreshold;){for(var exits=graph.edges[currentEdge.destination._index],straightestEdge=null,deltaAngle=0,i=0;i<exits.length;i++){var exit=exits[i];if(exit.getDistance()>0)if(null!=straightestEdge){var newDelta=-differenceBetweenAngles(currentEdge.getAngle(),exit.getAngle());Math.abs(newDelta)<Math.abs(deltaAngle)&&(straightestEdge=exit,deltaAngle=newDelta)}else straightestEdge=exit,deltaAngle=-differenceBetweenAngles(currentEdge.getAngle(),exit.getAngle())}if(null==straightestEdge)return null;if(Math.abs(deltaAngle)>=angleThreshold)return null;if(totalAngle+=deltaAngle,totalDistance+=straightestEdge.getDistance(),Math.abs(totalAngle)>=angleThreshold||totalDistance>distanceThreshold)return null;if(null!=straightestEdge.destination.locations[0])return straightestEdge.destination.locations[0];currentEdge=straightestEdge}return null}function differenceBetweenAngles(a,b){return((b-a+Math.PI)%(2*Math.PI)+2*Math.PI)%(2*Math.PI)-Math.PI}MappedinCategory._fetch=function(mappedin,cb){var query={fields:mappedin._things.categories,venue:mappedin._venue};mappedin._getArray("category",query,(function(err,data){if(err)return cb(err);for(var i=0,iLen=data.length;i<iLen;++i)data[i]=new MappedinCategory(mappedin,data[i]);cb(null,data)}))},defineLazyGetter(MappedinCategory,"locations",(function(){for(var related=[],locations=this._mappedin.locations,id=this._data.id,i=0,iLen=locations.length;i<iLen;++i){var location=locations[i],through=location._data.categories;if(Array.isArray(through))for(var j=0,jLen=through.length;j<jLen;++j)if(through[j]===id){related.push(location);break}}return related})),MappedinLocation._fetch=function(mappedin,cb){var fields=mappedin._things.locations.slice();mappedin._things.categories&&addToSet(fields,"categories"),mappedin._things.nodes&&addToSet(fields,"nodes"),mappedin._things.polygons&&addToSet(fields,"polygons"),mappedin._things.locationStates&&addToSet(fields,"states");var query={fields:fields,venue:mappedin._venue};mappedin._getArray("location",query,(function(err,data){if(err)return cb(err);mappedin._includeHidden||(data=data.filter((function(datum){return!datum.hidden})));for(var i=0,iLen=data.length;i<iLen;++i)data[i]=new MappedinLocation(mappedin,data[i]);cb(null,data)}))},defineLazyGetter(MappedinLocation,"polygons",(function(){var related=[],through=this._data.polygons,index=this._mappedin._polygonsById;if(Array.isArray(through))for(var i=0,iLen=through.length;i<iLen;++i){var polygon=index[through[i].id];null!=polygon&&polygon.geometry.visible&&related.push(polygon)}return related})),defineLazyGetter(MappedinLocation,"rank",(function(){var _this=this,rankings=this._mappedin._data.locationRankings;if(!rankings||!rankings.locations)return null;var thisRankData=rankings.locations.find((function(datum){return datum.ids.find((function(x){return x===_this.id}))}));return thisRankData?thisRankData.score:null})),defineLazyGetter(MappedinLocation,"nodes",(function(){var related=[],through=this._data.nodes,index=this._mappedin._nodesById;if(through)for(var i=0,iLen=through.length;i<iLen;++i){var node=index[through[i].node];null!=node&&related.push(node)}return related})),defineLazyGetter(MappedinLocation,"nodeOperationHours",(function(){return this._data.nodes.reduce((function(map,node){return map[node.node]=node.operationHours,map}),{})})),defineLazyGetter(MappedinLocation,"parent",(function(){var related,locations=this._mappedin._locationsById,parentId=this._data.parent;return void 0!==parentId&&(related=locations[parentId]),related})),defineLazyGetter(MappedinLocation,"state",(function(){return function(location,states){var date=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Date.now();if(location.states){var now=date||Date.now(),currentState=location.states.find((function(state){var start=new Date(state.start||DISTANT_PAST),end=new Date(state.end||FAR_FUTURE);return start<now&&end>now}));if(currentState)return states.find((function(state){return state.value===currentState.type}))}}(this._data,this._mappedin.locationStates)})),MappedinLocation.prototype.directionsTo=function(destination,options,cb){var directionsOptions=options||{};if((null!=directionsOptions.directionsProvider?directionsOptions.directionsProvider:directionsProvider.ONLINE)==directionsProvider.OFFLINE)directionsTo(this._mappedin,this.nodes,this,destination,options,cb);else{var query={originLocation:this._data.id,destination:void 0,location:void 0,perspective:this._mappedin._do2D&&this._mappedin._perspective||void 0,accessible:null!=options&&directionsOptions.accessible||void 0};if(destination instanceof MappedinLocation)query.location=destination._data.id;else{if(!(destination instanceof MappedinNode))throw new TypeError("destination must be a [MappedinLocation,MappedinNode]");query.destination=destination._data.id}this._mappedin._getObject("directions",query,cb)}},MappedinLocation.prototype.distanceTo=function(destination,options,cb){null==this._mappedin.venue.navigationGraph&&(this._mappedin.venue.navigationGraph=new NavigationGraph(this._mappedin.nodes,this._mappedin.vortexes)),distanceTo(this._mappedin.venue.navigationGraph,this.nodes,destination,options,cb)},MappedinVortex._fetch=function(mappedin,cb){var fields=mappedin._things.vortexes.slice();["name","type","accessible","weight","multiplier","nodes"].forEach((function(field){addToSet(fields,field)}));var query={fields:fields,venue:mappedin._venue};mappedin._getArray("vortex",query,(function(err,data){if(err)return cb(err);for(var i=0,iLen=data.length;i<iLen;++i)data[i]=new MappedinVortex(mappedin,data[i]);cb(null,data)}))},MappedinMapGroup._fetch=function(mappedin,cb){var query={fields:mappedin._things.mapGroups.slice(),venue:mappedin._venue};mappedin._getArray("map-group",query,(function(err,data){if(err)return cb(err);for(var i=0,iLen=data.length;i<iLen;++i)data[i]=new MappedinMapGroup(mappedin,data[i]);cb(null,data)}))},defineLazyGetter(MappedinMapGroup,"maps",(function(){for(var related=[],maps=this._mappedin.maps,id=this._data.id,i=0,iLen=maps.length;i<iLen;++i){var map=maps[i];map._data.group===id&&related.push(map)}return related})),MappedinMap._fetch=function(mappedin,cb){var fields=mappedin._things.maps.slice();mappedin._perspective&&addToSet(fields,"perspectives"),mappedin._things.mapGroups&&addToSet(fields,"group"),addToSet(fields,"elevation"),addToSet(fields,"x_scale"),addToSet(fields,"scale");var query={fields:fields,perspective:mappedin._perspective||void 0,venue:mappedin._venue};mappedin._getArray("map",query,(function(err,data){if(err)return cb(err);for(var setVisibleLayer=function(layerName){var layerObject=map.layers.find((function(l){return l.id===layerName}));layerObject?layerObject.visible=!0:map.layers.push({id:layerName,visible:!0})},i=0,iLen=data.length;i<iLen;++i){var map=data[i];if(mappedin._perspective){var per=map.perspective;null!=per&&(map.perspectiveId=per.id,mappedin._do2D?(fields.indexOf("width")>-1&&(map.width=per.size&&per.size.width||per.width),fields.indexOf("height")>-1&&(map.height=per.size&&per.size.height||per.height),fields.indexOf("tiles")>-1&&(map.tiles=per.tiles),fields.indexOf("original")>-1&&(map.original=per.original)):(fields.indexOf("scene")>-1&&(map.scene=per.scene),per.layers?(map.layers.forEach((function(layer){layer.visible=!1})),per.layers.forEach(setVisibleLayer)):map.layers.forEach((function(layer){layer.visible=!0})))),delete map.perspective}data[i]=new MappedinMap(mappedin,map)}cb(null,data)}))},defineLazyGetter(MappedinMap,"polygons",(function(){for(var related=[],polygons=this._mappedin.polygons,id=this._data.id,i=0,iLen=polygons.length;i<iLen;++i){var polygon=polygons[i];polygon.map===id&&related.push(polygon)}return related})),defineLazyGetter(MappedinMap,"mapGroup",(function(){var id=this._data.group;return id&&this._mappedin._mapGroupsById[id]||null})),MappedinNode._fetch=function(mappedin,cb){var fields=mappedin._things.nodes.slice();mappedin._things.maps&&addToSet(fields,"map");["weight","multiplier","accessible"].forEach((function(field){addToSet(fields,field)}));var query={fields:fields,perspective:mappedin._do2D&&mappedin._perspective||void 0,venue:mappedin._venue};mappedin._getArray("node",query,(function(err,data){if(err)return cb(err);for(var i=0,iLen=data.length;i<iLen;++i)data[i]=new MappedinNode(mappedin,data[i],i);cb(null,data)}))},defineLazyGetter(MappedinNode,"paths",(function(){var related=[],index=this._mappedin._nodesById,through=this._data.paths;if(Array.isArray(through))for(var i=0,iLen=through.length;i<iLen;++i){var node=index[through[i].node];null!=node&&related.push(node)}return related})),defineLazyGetter(MappedinNode,"locations",(function(){for(var related=[],locations=this._mappedin.locations,nodeId=this._data.id,i=0,iLen=locations.length;i<iLen;++i){var location=locations[i],through=location._data.nodes;if(Array.isArray(through))for(var j=0,jLen=through.length;j<jLen;++j){if(through[j].node===nodeId){related.push(location);break}}}return related})),MappedinNode.prototype.getAngle=function(to){var xDelta=this.x-to.x,yDelta=this.y-to.y;return(Math.atan2(yDelta,xDelta)+2.5*Math.PI)%(2*Math.PI)},MappedinNode.prototype.getDistance=function(to){var scale,xDelta=this.x-to.x,yDelta=this.y-to.y,lengthSquared=xDelta*xDelta+yDelta*yDelta;return scale=null==this._mappedin._mapsById[this.map]?1:this._mappedin._mapsById[this.map]._scale,Math.sqrt(lengthSquared)/scale},MappedinNode.prototype.getShortestEuclideanDistance=function(destinations){var origin=this,shortestSoFar=Number.MAX_VALUE;return destinations.forEach((function(destination){var distance=origin.getDistance(destination);shortestSoFar>distance&&(shortestSoFar=distance)})),shortestSoFar},MappedinNode.prototype.directionsTo=function(destination,options,cb){var directionsOptions=options||{};if((null!=directionsOptions.directionsProvider?directionsOptions.directionsProvider:directionsProvider.ONLINE)==directionsProvider.OFFLINE){var departFrom=this.locations.length>0?this.locations[0]:null;directionsTo(this._mappedin,[this],departFrom,destination,options,cb)}else{var query={origin:this._data.id,destination:void 0,location:void 0,perspective:this._mappedin._do2D&&this._mappedin._perspective||void 0,accessible:null!=options&&directionsOptions.accessible||void 0};if(destination instanceof MappedinLocation)query.location=destination._data.id;else{if(!(destination instanceof MappedinNode))throw new TypeError("destination must be a [MappedinLocation,MappedinNode]");query.destination=destination._data.id}this._mappedin._getObject("directions",query,cb)}},MappedinNode.prototype.distanceTo=function(destination,options,cb){null==this._mappedin.venue.navigationGraph&&(this._mappedin.venue.navigationGraph=new NavigationGraph(this._mappedin.nodes,this._mappedin.vortexes)),distanceTo(this._mappedin.venue.navigationGraph,[this],destination,options,cb)},Edge.prototype.getAngle=function(){return this.origin.getAngle(this.destination)},Edge.prototype.getDistance=function(){return this.distance},NavigationGraph.prototype.aStar=function(origins,destinations,accessible){if(0==origins.length||0==destinations.length)return null;var frontier=[],cameFrom={},costSoFar={};for(origins.forEach((function(origin){var priority=origin.getShortestEuclideanDistance(destinations);frontier.push({origin:origin,priority:priority});var id=origin.id;cameFrom[id]=null,costSoFar[id]=0})),frontier.sort((function(a,b){return a.priority-b.priority}));frontier.length>0;){var current=frontier[0];if(destinations.includes(current.origin)){for(var directions=[],step=cameFrom[current.origin.id];null!=step;){directions.push(step);var nextStep=cameFrom[step.origin.id];step=null!=nextStep?nextStep:null}return directions.reverse()}for(var i=0;i<this.edges[current.origin._index].length;i++){var edge=this.edges[current.origin._index][i];if((!accessible||null==edge.vortex||!1!==edge.vortex.accessible)&&(!accessible||!1!==edge.origin.accessible&&!1!==edge.destination.accessible)){var newCost=costSoFar[current.origin.id]+edge.weight;if(null==costSoFar[edge.destination.id]||newCost<costSoFar[edge.destination.id]){costSoFar[edge.destination.id]=newCost;var cost=newCost+edge.destination.getShortestEuclideanDistance(destinations);frontier.push({origin:edge.destination,priority:cost}),cameFrom[edge.destination.id]=edge}}}frontier.splice(0,1),frontier.sort((function(a,b){return a.priority-b.priority}))}return null};var directionsProvider={ONLINE:"online",OFFLINE:"offline"};function MappedinDirective(origin,action,atLocation,instruction){this.node=origin,this.action=action,this.atLocation=atLocation,this.instruction=instruction}var actionType={DEPARTURE:"Departure",TAKEVORTEX:"TakeVortex",TURN:"Turn",ARRIVAL:"Arrival"},bearingType={STRAIGHT:"Straight",RIGHT:"Right",SLIGHTRIGHT:"SlightRight",LEFT:"Left",SLIGHTLEFT:"SlightLeft"};function MappedinPolygon(mappedin,data){this._mappedin=mappedin,this._data=data,this._cache={},assignMissing(this,data)}function MappedinVenue(mappedin,data){this._mappedin=mappedin,this._data=data,this._cache={},this.navigationGraph=null,assignMissing(this,data)}function MappedinTheme(mappedin,data){this._mappedin=mappedin,this._data=data,this._cache={},assignMissing(this,data)}function MappedinEvent(mappedin,data){this._mappedin=mappedin,this._data=data,this._cache={},assignMissing(this,data)}function MappedinLocationState(mappedin,data){this._mappedin=mappedin,this._data=data,this._cache={},assignMissing(this,data)}function MappedinLocationRankings(mappedin,data){this._mappedin=mappedin,this._data=data,this._cache={},assignMissing(this,data)}function MappedinPolygonRankings(mappedin,data){this._mappedin=mappedin,this._data=data,this._cache={},assignMissing(this,data)}MappedinPolygon._fetch=function(mappedin,cb){var fields=mappedin._things.polygons.slice();mappedin._things.maps&&addToSet(fields,"map"),mappedin._things.nodes&&addToSet(fields,"entrances");var query={fields:fields,perspective:mappedin._do2D&&mappedin._perspective||void 0,venue:mappedin._venue};mappedin._getArray("polygon",query,(function(err,data){if(err)return cb(err);var visiblePolygons=data.filter((function(item){return item.geometry.visible})).map((function(item){return new MappedinPolygon(mappedin,item)}));cb(null,visiblePolygons)}))},defineLazyGetter(MappedinPolygon,"locations",(function(){for(var related=[],locations=this._mappedin.locations,id=this._data.id,i=0,iLen=locations.length;i<iLen;++i){var location=locations[i],through=location._data.polygons;if(Array.isArray(through))for(var j=0,jLen=through.length;j<jLen;++j){if(through[j].id===id){related.push(location);break}}}return related})),defineLazyGetter(MappedinPolygon,"entrances",(function(){var related=[],through=this._data.entrances,index=this._mappedin._nodesById;if(Array.isArray(through))for(var i=0,iLen=through.length;i<iLen;++i){var node=index[through[i].id];null!=node&&related.push(node)}return related})),defineLazyGetter(MappedinPolygon,"rank",(function(){var _this2=this,rankings=this._mappedin._data.polygonRankings;if(!rankings||!rankings.polygons)return null;var thisRankData=rankings.polygons.find((function(x){return x.polygonId===_this2.id}));return thisRankData?{score:thisRankData.score,node:thisRankData.entranceNodeId}:null})),MappedinPolygon.prototype.directionsTo=function(destination,options,cb){var directionsOptions=options||{};if((null!=directionsOptions.directionsProvider?directionsOptions.directionsProvider:directionsProvider.ONLINE)==directionsProvider.OFFLINE){var departFrom=this.locations.length>0?this.locations[0]:null;directionsTo(this._mappedin,this.entrances,departFrom,destination,options,cb)}else{var query={originLocation:this._data.id,destination:void 0,location:void 0,perspective:this._mappedin._do2D&&this._mappedin._perspective||void 0,accessible:directionsOptions.accessible||void 0};if(destination instanceof MappedinLocation)query.location=destination._data.id;else{if(!(destination instanceof MappedinNode))throw new TypeError("destination must be a [MappedinLocation,MappedinNode]");query.destination=destination._data.id}this._mappedin._getObject("directions",query,cb)}},MappedinPolygon.prototype.distanceTo=function(destination,options,cb){null==this._mappedin.venue.navigationGraph&&(this._mappedin.venue.navigationGraph=new NavigationGraph(this._mappedin.nodes,this._mappedin.vortexes)),distanceTo(this._mappedin.venue.navigationGraph,this.entrances,destination,options,cb)},MappedinVenue._fetch=function(mappedin,cb){var query={fields:mappedin._things.venue,slug:mappedin._venue,limit:1};mappedin._getArray("venue",query,(function(err,data){if(err)return cb(err);if(data.length<1)cb(new Error("venue not found"));else{var venue=new MappedinVenue(mappedin,data[0]);cb(null,venue)}}))},MappedinTheme._fetch=function(mappedin,cb){var query={fields:mappedin._things.themes.slice(),venue:mappedin._venue};mappedin._getArray("apollo-theme",query,(function(err,data){if(err)return cb(err);for(var i=0;i<data.length;++i)data[i]=new MappedinTheme(mappedin,data[i]);cb(null,data)}))},MappedinEvent._fetch=function(mappedin,cb){var fields=mappedin._things.events.slice();mappedin._things.locations&&addToSet(fields,"location");var query={fields:fields,venue:mappedin._venue,activeAtOrAfter:Date.now()};mappedin._getArray("event",query,(function(err,data){if(err)return cb(err);for(var i=0;i<data.length;++i)data[i]=new MappedinEvent(mappedin,data[i]);cb(null,data)}))},defineLazyGetter(MappedinEvent,"location",(function(){var related=null,through=this._mappedin._locationsById,locationId=this._data.location;if(null!=locationId){var location=through[locationId];null!=location&&(related=location)}return related})),MappedinLocationState._fetch=function(mappedin,cb){var query={fields:mappedin._things.locationStates.slice(),venue:mappedin._venue};mappedin._getArray("location-state",query,(function(err,data){if(err)return cb(err);for(var i=0,iLen=data.length;i<iLen;++i)data[i]=new MappedinLocationState(mappedin,data[i]);cb(null,data)}))},MappedinLocationRankings._fetch=function(mappedin,cb){mappedin._getObject("smart-labels/location-label-ranking",{venue:mappedin._venue},(function(err,data){if(err)return cb(err);data=new MappedinLocationRankings(mappedin,data),cb(null,data)}),!0)},MappedinPolygonRankings._fetch=function(mappedin,cb){mappedin._getObject("smart-labels/polygon-label-ranking",{venue:mappedin._venue},(function(err,data){if(err)return cb(err);data=new MappedinPolygonRankings(mappedin,data),cb(null,data)}),!0)};var THINGS={categories:MappedinCategory,locations:MappedinLocation,vortexes:MappedinVortex,maps:MappedinMap,nodes:MappedinNode,polygons:MappedinPolygon,venue:MappedinVenue,events:MappedinEvent,mapGroups:MappedinMapGroup,themes:MappedinTheme,locationStates:MappedinLocationState,locationRankings:MappedinLocationRankings,polygonRankings:MappedinPolygonRankings};function Mappedin(options){var baseUrl="https://api-gateway.mappedin.com/public/1/",supplementaryUrl="https://api-gateway.mappedin.com/analytics/";options.noAuth||!options.clientId||isGatewayKey(options.clientId)||(baseUrl="https://web-proxy.mappedin.com/1/",supplementaryUrl=void 0),this._headers=options.headers||{},this._accessToken=options.accessToken||null,this._clientId=options.clientId||null,this._clientSecret=options.clientSecret||null,this._baseUrl=options.baseUrl||baseUrl,this._supplementaryUrl=options.baseUrl||supplementaryUrl,this._includeHidden=null==options.includeHidden||options.includeHidden,this._baseUrl.includes("gateway")&&(this._apiGateway=!0),this._perspective=options.perspective||null,this._language=options.language||null,this._things=options.things||{},this._venue=options.venue||null,this._do2D=options.do2D||!1,this._data={},this._cache={},this._authorization=null,options.noAuth||(this._accessToken?this._authorization="Bearer "+this._accessToken:this._clientId&&this._clientSecret&&(this._authorization="Basic "+btoa(this._clientId+":"+this._clientSecret)))}function stringifyQuery(query){var gateway=arguments.length>1&&void 0!==arguments[1]&&arguments[1],queryString="";if(null!=query)for(var delim="?",keys=gateway?Object.keys(query).filter((function(key){return!["slug","venue"].includes(key)})):Object.keys(query),i=0,iLen=keys.length;i<iLen;++i){var name=keys[i],value=query[name];null!=value&&(queryString+=delim+encodeURIComponent(name)+"="+encodeURIComponent(value),delim="&")}return queryString}Mappedin.prototype._getJSONPromise=function(url,options){var requestOptions=this._buildRequestOptions(options),supplementary=options.supplementary;requestOptions.language&&(url+="&lang="+encodeURIComponent(requestOptions.language));var headers=this._headers;headers["Content-Type"]="text/json",this._authorization&&(headers.Authorization=this._authorization),requestOptions.language&&(headers["Accept-Language"]=requestOptions.language);var req={method:"GET",headers:headers};return new Promise((function(resolve,reject){var resolveIfSupplementary=function(err){supplementary?resolve({}):reject(err)};fetch(url,req).then((function(response){return response.ok||resolveIfSupplementary(new Error(response.status+" "+response.statusText)),response.json()})).then(resolve).catch(resolveIfSupplementary)}))},Mappedin.prototype._buildRequestOptions=function(options){var requestOptions={language:this._language,clientId:this._clientId,clientSecret:this._clientSecret};return options&&options.supplementary&&delete requestOptions.language,requestOptions},Mappedin.prototype._buildUrl=function(pathname,query,supplementary){return supplementary?"".concat(this._supplementaryUrl).concat(pathname,"?venue=").concat(query.venue||query.slug):this._apiGateway?"".concat(this._baseUrl).concat(pathname,"/").concat(query.venue||query.slug)+stringifyQuery(query,this._apiGateway):this._baseUrl+pathname+stringifyQuery(query)},Mappedin.prototype._getObject=function(pathname,query,cb,supplementary){var url=this._buildUrl(pathname,query,supplementary);this._getJSONPromise(url,{supplementary:supplementary}).then((function(res){Array.isArray(res)?1===res.length?cb(null,res[0]):cb(new Error("invalid response object")):cb(null,res)})).catch((function(err){cb(err)}))},Mappedin.prototype._getArray=function(pathname,query,cb){var url=this._buildUrl(pathname,query);this._getJSONPromise(url,{}).then((function(res){cb(null,res)})).catch((function(err){cb(err)}))},Object.keys(THINGS).forEach((function(name){defineGetter(Mappedin,name,(function(){var array=this._data[name];if(void 0===array)throw new Error(name+" were not fetched");return array}))})),Object.keys(THINGS).forEach((function(name){defineLazyGetter(Mappedin,"_"+name+"ById",(function(){var array=this._data[name];if(void 0===array)throw new Error(name+": not fetched");if(!Array.isArray(array))throw new TypeError(name+": not an Array");for(var index=Object.create(null),i=0,iLen=array.length;i<iLen;++i){var object=array[i],objectId=object.id;null!=objectId&&(index[objectId]=object)}return index})),defineLazyGetter(Mappedin,"_"+name+"ByExternalId",(function(){var array=this._data[name];if(void 0===array)throw new Error(name+": not fetched");if(!Array.isArray(array))throw new TypeError(name+": not an Array");for(var index=Object.create(null),i=0,iLen=array.length;i<iLen;++i){var object=array[i],objectId=object.externalId;null!=objectId&&(index[objectId]=object)}return index}))}));var collectionType={CATEGORY:"categories",EVENT:"events",LOCATION:"locations",MAPGROUP:"mapGroups",MAP:"maps",NODE:"nodes",POLYGON:"polygons",VORTEX:"vortexes"};function isString(value){return"string"==typeof value&&value.length>0}function getVenue(options,cb){if(!options)throw new TypeError("options must be an Object");if(!(isString(options.clientId)&&isString(options.clientSecret)||isString(options.accessToken)||options.noAuth))throw new Error("{clientId,clientSecret} must be a String");if(void 0!==options.perspective&&!isString(options.perspective))throw new Error("perspective must be a String");if(void 0!==options.language&&!isString(options.language))throw new Error("language must be a String");if(!function(things){if(null==things||"object"!==_typeof(things))return!1;for(var keys=Object.keys(things),i=0,iLen=keys.length;i<iLen;++i){var props=things[keys[i]];if(!Array.isArray(props))return!1;for(var j=0,jLen=props.length;j<jLen;++j)if(!isString(props[j]))return!1}return!0}(options.things))throw new Error("things must be an Object of [Array of String]");if(!isString(options.venue))throw new Error("venue must be a String");var mappedin=new Mappedin(options);mappedin._fetchAll((function(err){if(err)return cb(err);cb(null,mappedin)}))}Object.freeze(collectionType),Mappedin.prototype.getCollectionItemById=function(name,id){var collection=this["_"+collectionType[name]+"ById"];return null!=collection&&null!=collection[id]?collection[id]:null!=(collection=this["_"+collectionType[name]+"ByExternalId"])&&null!=collection[id]?collection[id]:null},Mappedin.prototype._fetchAll=function(cb){var didInvokeCallback=!1;"vortexes"in this._things||(this._things.vortexes=["name","type","accessible","weight","multiplier","nodes"]),"locationStates"in this._things||(this._things.locationStates=["name","id","value"]),isGatewayKey(this._clientId)||(this._things.polygonRankings&&delete this._things.polygonRankings,this._things.locationRankings&&delete this._things.locationRankings);var things=this._things,names=Object.keys(things),total=names.length,progress=0;function onfetched(name,err,data){if(!didInvokeCallback){if(err)return didInvokeCallback=!0,err.message+=" (Fetching ".concat(name," failed)"),void cb(err);this._data[name]=data,++progress>=total&&(didInvokeCallback=!0,cb())}}for(var i=0,iLen=names.length;i<iLen;++i){var name=names[i];THINGS[name]._fetch(this,onfetched.bind(this,name))}total<=0&&setTimeout(cb,0)};var TEST_KEY="mappedin3DTestSuccess",modes={TEST:"TEST","3D":"3D","2D":"2D",FORCE_TEST:"FORCE_TEST"};function forceTest(container,callback,loadMapViewByMode){!function(container,cb){var gl,webglsupport=!1;try{var canvas=document.createElement("canvas");if(gl=canvas.getContext("webgl",{antialias:!0})||canvas.getContext("experimental-webgl",{antialias:!0}),(webglsupport=!(!window.WebGLRenderingContext||!gl))&&!gl.getContextAttributes().antialias)return cb(results.RESULT.FAILED_NO_AA,!1,results.NO_BENCHMARK);canvas=null}catch(e){webglsupport=!1}if(!webglsupport)return cb(results.RESULT.FAILED_NO_WEB_GL,!1,results.NO_BENCHMARK);cb(results.RESULT.SUCCESS,!0,results.NO_BENCHMARK)}(0,(function(result,success,benchmark){if(1==success||result!==results.RESULT.FAILED_TOO_SLOW)try{window.localStorage.setItem(TEST_KEY,success)}catch(e){}loadMapViewByMode&&loadMapViewByMode(success),callback(result,success,benchmark)}))}function getVenue$1(options,mode,callback){mode!=modes.TEST?(options.things.venue=options.things.venue||[],options.things.venue.push("slug","defaultMap"),options.things.nodes=options.things.nodes||[],options.things.nodes.push("x","y","paths","map"),options.things.polygons=options.things.polygons||[],options.things.locations=options.things.locations||[],options.things.locations.push("sortOrder","parent","showSmartLabelWhenImagePresent","hidden"),options.things.maps=options.things.maps||[],options.things.maps.push("height","width","georeference"),mode==modes["2D"]?(options.perspective=options.perspective2D||options.perspective||"Perspective",options.things.maps.push("tiles","perspectives"),options.things.polygons.push("vertexes","geometry"),options.do2D=!0):mode==modes["3D"]&&(options.perspective=options.perspective3D||options.perspective||void 0,options.things.maps.push("scene","layers"),options.things.polygons.push("canvasBounds","map","image","perspectives","material","holes","label","geometry"),options.do2D=!1),getVenue(options,callback)):console.error("You need to run the 3D test, or call force3D or force2D first.")}var isEntries,isEnum=_objectPie.f,$values=(isEntries=!1,function(it){for(var key,O=_toIobject(it),keys=_objectKeys(O),length=keys.length,i=0,result=[];length>i;)key=keys[i++],_descriptors&&!isEnum.call(O,key)||result.push(isEntries?[key,O[key]]:O[key]);return result});_export(_export.S,"Object",{values:function(it){return $values(it)}});var strictUriEncode=function(str){return encodeURIComponent(str).replace(/[!'()*]/g,(function(c){return"%"+c.charCodeAt(0).toString(16).toUpperCase()}))},getOwnPropertySymbols=Object.getOwnPropertySymbols,hasOwnProperty$1=Object.prototype.hasOwnProperty,propIsEnumerable=Object.prototype.propertyIsEnumerable;
/*
object-assign
(c) Sindre Sorhus
@license MIT
*/function toObject(val){if(null==val)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(val)}var objectAssign=function(){try{if(!Object.assign)return!1;var test1=new String("abc");if(test1[5]="de","5"===Object.getOwnPropertyNames(test1)[0])return!1;for(var test2={},i=0;i<10;i++)test2["_"+String.fromCharCode(i)]=i;if("0123456789"!==Object.getOwnPropertyNames(test2).map((function(n){return test2[n]})).join(""))return!1;var test3={};return"abcdefghijklmnopqrst".split("").forEach((function(letter){test3[letter]=letter})),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},test3)).join("")}catch(err){return!1}}()?Object.assign:function(target,source){for(var from,symbols,to=toObject(target),s=1;s<arguments.length;s++){for(var key in from=Object(arguments[s]))hasOwnProperty$1.call(from,key)&&(to[key]=from[key]);if(getOwnPropertySymbols){symbols=getOwnPropertySymbols(from);for(var i=0;i<symbols.length;i++)propIsEnumerable.call(from,symbols[i])&&(to[symbols[i]]=from[symbols[i]])}}return to};new RegExp("%[a-f0-9]{2}","gi"),new RegExp("(%[a-f0-9]{2})+","gi");function encode(value,opts){return opts.encode?opts.strict?strictUriEncode(value):encodeURIComponent(value):value}var queryString_stringify=function(obj,opts){!1===(opts=objectAssign({encode:!0,strict:!0,arrayFormat:"none"},opts)).sort&&(opts.sort=function(){});var formatter=function(opts){switch(opts.arrayFormat){case"index":return function(key,value,index){return null===value?[encode(key,opts),"[",index,"]"].join(""):[encode(key,opts),"[",encode(index,opts),"]=",encode(value,opts)].join("")};case"bracket":return function(key,value){return null===value?encode(key,opts):[encode(key,opts),"[]=",encode(value,opts)].join("")};default:return function(key,value){return null===value?encode(key,opts):[encode(key,opts),"=",encode(value,opts)].join("")}}}(opts);return obj?Object.keys(obj).sort(opts.sort).map((function(key){var val=obj[key];if(void 0===val)return"";if(null===val)return encode(key,opts);if(Array.isArray(val)){var result=[];return val.slice().forEach((function(val2){void 0!==val2&&result.push(formatter(key,val2,result.length))})),result.join("&")}return encode(key,opts)+"="+encode(val,opts)})).filter((function(x){return x.length>0})).join("&"):""},VALID_CONTEXTS=["websdk","web","webv2"],Analytics=function Analytics(options){var defaultUrl=isGatewayKey((options=options||{}).key)?"https://api-gateway.mappedin.com/track-analytics/a/":"https://web-proxy.mappedin.com/a/",baseUrl=options.url||options.baseUrl||defaultUrl;baseUrl+=options.venue+"/";var key=options.key,secret=options.secret,geolocationMode=!1,testMode=options.testMode,context=VALID_CONTEXTS.find((function(context){return context===options.context}))||VALID_CONTEXTS[0],MI_UUID=getDeviceID(),MI_SESSION=getSessionID(),track=function(target){var query=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!0!==testMode&&"True"!==testMode&&"true"!==testMode){var queryParams=_objectSpread2({},query,{g:geolocationMode}),url=baseUrl+target+"?"+queryString_stringify(queryParams),reqOptions={method:"GET",mode:"cors",headers:{"mi-context":context,"mi-session":MI_SESSION,"mi-device":MI_UUID,Authorization:"Basic "+btoa(key+":"+secret)}};fetch(url,reqOptions)}};this.locationSelected=function(location){var locationId=location.id||location;track("select-location",{id:locationId})},this.categorySelected=function(category){var categoryId=category.id||category;track("select-category",{id:categoryId})},this.mapViewLoaded=function(type,forced,benchmark,reason){track("load-mapview",{type:type,force:forced,benchmark:benchmark||-1,reason:reason||"success"}),delete this.mapViewLoaded},this.getDirections=function(start,end){track("query-directions",{start:start,end:end,type:"location_to_location"})},this.getSessionID=function(){return MI_SESSION},this.getDeviceID=function(){return MI_UUID},this.setGeolocationMode=function(mode){geolocationMode=mode},this.trackBlueDotEvent=function(blueDotEvent){blueDotEvent&&Object.values(Analytics.BLUEDOT_EVENT).includes(blueDotEvent)?track(blueDotEvent):console.warn('Ignored unsupported blue dot event: "'.concat(blueDotEvent,'".'))}};Analytics.BLUEDOT_EVENT={ATTEMPT_BLUEDOT:"attempt-bluedot",FOUND_POSITION:"found-position",FOUND_FLOOR:"found-floor"};var $startsWith="".startsWith;_export(_export.P+_export.F*_failsIsRegexp("startsWith"),"String",{startsWith:function(searchString){var that=_stringContext(this,searchString,"startsWith"),index=_toLength(Math.min(arguments.length>1?arguments[1]:void 0,that.length)),search=String(searchString);return $startsWith?$startsWith.call(that,search,index):that.slice(index,index+search.length)===search}});var _wksExt={f:_wks},defineProperty=_objectDp.f,_wksDefine=function(name){var $Symbol=_core.Symbol||(_core.Symbol=_global.Symbol||{});"_"==name.charAt(0)||name in $Symbol||defineProperty($Symbol,name,{value:_wksExt.f(name)})};_wksDefine("asyncIterator");var _objectGops={f:Object.getOwnPropertySymbols},gOPN$1=_objectGopn.f,toString$1={}.toString,windowNames="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],_objectGopnExt={f:function(it){return windowNames&&"[object Window]"==toString$1.call(it)?function(it){try{return gOPN$1(it)}catch(e){return windowNames.slice()}}(it):gOPN$1(_toIobject(it))}},META=_meta.KEY,gOPD$2=_objectGopd.f,dP$3=_objectDp.f,gOPN$2=_objectGopnExt.f,$Symbol=_global.Symbol,$JSON=_global.JSON,_stringify=$JSON&&$JSON.stringify,HIDDEN=_wks("_hidden"),TO_PRIMITIVE=_wks("toPrimitive"),isEnum$1={}.propertyIsEnumerable,SymbolRegistry=_shared("symbol-registry"),AllSymbols=_shared("symbols"),OPSymbols=_shared("op-symbols"),ObjectProto$1=Object.prototype,USE_NATIVE$1="function"==typeof $Symbol&&!!_objectGops.f,QObject=_global.QObject,setter=!QObject||!QObject.prototype||!QObject.prototype.findChild,setSymbolDesc=_descriptors&&_fails((function(){return 7!=_objectCreate(dP$3({},"a",{get:function(){return dP$3(this,"a",{value:7}).a}})).a}))?function(it,key,D){var protoDesc=gOPD$2(ObjectProto$1,key);protoDesc&&delete ObjectProto$1[key],dP$3(it,key,D),protoDesc&&it!==ObjectProto$1&&dP$3(ObjectProto$1,key,protoDesc)}:dP$3,wrap=function(tag){var sym=AllSymbols[tag]=_objectCreate($Symbol.prototype);return sym._k=tag,sym},isSymbol=USE_NATIVE$1&&"symbol"==typeof $Symbol.iterator?function(it){return"symbol"==typeof it}:function(it){return it instanceof $Symbol},$defineProperty=function(it,key,D){return it===ObjectProto$1&&$defineProperty(OPSymbols,key,D),_anObject(it),key=_toPrimitive(key,!0),_anObject(D),_has(AllSymbols,key)?(D.enumerable?(_has(it,HIDDEN)&&it[HIDDEN][key]&&(it[HIDDEN][key]=!1),D=_objectCreate(D,{enumerable:_propertyDesc(0,!1)})):(_has(it,HIDDEN)||dP$3(it,HIDDEN,_propertyDesc(1,{})),it[HIDDEN][key]=!0),setSymbolDesc(it,key,D)):dP$3(it,key,D)},$defineProperties=function(it,P){_anObject(it);for(var key,keys=function(it){var result=_objectKeys(it),getSymbols=_objectGops.f;if(getSymbols)for(var key,symbols=getSymbols(it),isEnum=_objectPie.f,i=0;symbols.length>i;)isEnum.call(it,key=symbols[i++])&&result.push(key);return result}(P=_toIobject(P)),i=0,l=keys.length;l>i;)$defineProperty(it,key=keys[i++],P[key]);return it},$propertyIsEnumerable=function(key){var E=isEnum$1.call(this,key=_toPrimitive(key,!0));return!(this===ObjectProto$1&&_has(AllSymbols,key)&&!_has(OPSymbols,key))&&(!(E||!_has(this,key)||!_has(AllSymbols,key)||_has(this,HIDDEN)&&this[HIDDEN][key])||E)},$getOwnPropertyDescriptor=function(it,key){if(it=_toIobject(it),key=_toPrimitive(key,!0),it!==ObjectProto$1||!_has(AllSymbols,key)||_has(OPSymbols,key)){var D=gOPD$2(it,key);return!D||!_has(AllSymbols,key)||_has(it,HIDDEN)&&it[HIDDEN][key]||(D.enumerable=!0),D}},$getOwnPropertyNames=function(it){for(var key,names=gOPN$2(_toIobject(it)),result=[],i=0;names.length>i;)_has(AllSymbols,key=names[i++])||key==HIDDEN||key==META||result.push(key);return result},$getOwnPropertySymbols=function(it){for(var key,IS_OP=it===ObjectProto$1,names=gOPN$2(IS_OP?OPSymbols:_toIobject(it)),result=[],i=0;names.length>i;)!_has(AllSymbols,key=names[i++])||IS_OP&&!_has(ObjectProto$1,key)||result.push(AllSymbols[key]);return result};USE_NATIVE$1||(_redefine(($Symbol=function(){if(this instanceof $Symbol)throw TypeError("Symbol is not a constructor!");var tag=_uid(arguments.length>0?arguments[0]:void 0),$set=function(value){this===ObjectProto$1&&$set.call(OPSymbols,value),_has(this,HIDDEN)&&_has(this[HIDDEN],tag)&&(this[HIDDEN][tag]=!1),setSymbolDesc(this,tag,_propertyDesc(1,value))};return _descriptors&&setter&&setSymbolDesc(ObjectProto$1,tag,{configurable:!0,set:$set}),wrap(tag)}).prototype,"toString",(function(){return this._k})),_objectGopd.f=$getOwnPropertyDescriptor,_objectDp.f=$defineProperty,_objectGopn.f=_objectGopnExt.f=$getOwnPropertyNames,_objectPie.f=$propertyIsEnumerable,_objectGops.f=$getOwnPropertySymbols,_descriptors&&_redefine(ObjectProto$1,"propertyIsEnumerable",$propertyIsEnumerable,!0),_wksExt.f=function(name){return wrap(_wks(name))}),_export(_export.G+_export.W+_export.F*!USE_NATIVE$1,{Symbol:$Symbol});for(var es6Symbols="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),j$1=0;es6Symbols.length>j$1;)_wks(es6Symbols[j$1++]);for(var wellKnownSymbols=_objectKeys(_wks.store),k=0;wellKnownSymbols.length>k;)_wksDefine(wellKnownSymbols[k++]);_export(_export.S+_export.F*!USE_NATIVE$1,"Symbol",{for:function(key){return _has(SymbolRegistry,key+="")?SymbolRegistry[key]:SymbolRegistry[key]=$Symbol(key)},keyFor:function(sym){if(!isSymbol(sym))throw TypeError(sym+" is not a symbol!");for(var key in SymbolRegistry)if(SymbolRegistry[key]===sym)return key},useSetter:function(){setter=!0},useSimple:function(){setter=!1}}),_export(_export.S+_export.F*!USE_NATIVE$1,"Object",{create:function(it,P){return void 0===P?_objectCreate(it):$defineProperties(_objectCreate(it),P)},defineProperty:$defineProperty,defineProperties:$defineProperties,getOwnPropertyDescriptor:$getOwnPropertyDescriptor,getOwnPropertyNames:$getOwnPropertyNames,getOwnPropertySymbols:$getOwnPropertySymbols});var FAILS_ON_PRIMITIVES=_fails((function(){_objectGops.f(1)}));_export(_export.S+_export.F*FAILS_ON_PRIMITIVES,"Object",{getOwnPropertySymbols:function(it){return _objectGops.f(_toObject(it))}}),$JSON&&_export(_export.S+_export.F*(!USE_NATIVE$1||_fails((function(){var S=$Symbol();return"[null]"!=_stringify([S])||"{}"!=_stringify({a:S})||"{}"!=_stringify(Object(S))}))),"JSON",{stringify:function(it){for(var replacer,$replacer,args=[it],i=1;arguments.length>i;)args.push(arguments[i++]);if($replacer=replacer=args[1],(_isObject(replacer)||void 0!==it)&&!isSymbol(it))return _isArray(replacer)||(replacer=function(key,value){if("function"==typeof $replacer&&(value=$replacer.call(this,key,value)),!isSymbol(value))return value}),args[1]=replacer,_stringify.apply($JSON,args)}}),$Symbol.prototype[TO_PRIMITIVE]||_hide($Symbol.prototype,TO_PRIMITIVE,$Symbol.prototype.valueOf),_setToStringTag($Symbol,"Symbol"),_setToStringTag(Math,"Math",!0),_setToStringTag(_global.JSON,"JSON",!0);var re1,re2,_stringAt=function(TO_STRING){return function(that,pos){var a,b,s=String(_defined(that)),i=_toInteger(pos),l=s.length;return i<0||i>=l?TO_STRING?"":void 0:(a=s.charCodeAt(i))<55296||a>56319||i+1===l||(b=s.charCodeAt(i+1))<56320||b>57343?TO_STRING?s.charAt(i):a:TO_STRING?s.slice(i,i+2):b-56320+(a-55296<<10)+65536}},at=_stringAt(!0),_advanceStringIndex=function(S,index,unicode){return index+(unicode?at(S,index).length:1)},builtinExec=RegExp.prototype.exec,_regexpExecAbstract=function(R,S){var exec=R.exec;if("function"==typeof exec){var result=exec.call(R,S);if("object"!=typeof result)throw new TypeError("RegExp exec method returned something other than an Object or null");return result}if("RegExp"!==_classof(R))throw new TypeError("RegExp#exec called on incompatible receiver");return builtinExec.call(R,S)},_flags=function(){var that=_anObject(this),result="";return that.global&&(result+="g"),that.ignoreCase&&(result+="i"),that.multiline&&(result+="m"),that.unicode&&(result+="u"),that.sticky&&(result+="y"),result},nativeExec=RegExp.prototype.exec,nativeReplace=String.prototype.replace,patchedExec=nativeExec,UPDATES_LAST_INDEX_WRONG=(re1=/a/,re2=/b*/g,nativeExec.call(re1,"a"),nativeExec.call(re2,"a"),0!==re1.lastIndex||0!==re2.lastIndex),NPCG_INCLUDED=void 0!==/()??/.exec("")[1];(UPDATES_LAST_INDEX_WRONG||NPCG_INCLUDED)&&(patchedExec=function(str){var lastIndex,reCopy,match,i,re=this;return NPCG_INCLUDED&&(reCopy=new RegExp("^"+re.source+"$(?!\\s)",_flags.call(re))),UPDATES_LAST_INDEX_WRONG&&(lastIndex=re.lastIndex),match=nativeExec.call(re,str),UPDATES_LAST_INDEX_WRONG&&match&&(re.lastIndex=re.global?match.index+match[0].length:lastIndex),NPCG_INCLUDED&&match&&match.length>1&&nativeReplace.call(match[0],reCopy,(function(){for(i=1;i<arguments.length-2;i++)void 0===arguments[i]&&(match[i]=void 0)})),match});var _regexpExec=patchedExec;_export({target:"RegExp",proto:!0,forced:_regexpExec!==/./.exec},{exec:_regexpExec});var SPECIES$3=_wks("species"),REPLACE_SUPPORTS_NAMED_GROUPS=!_fails((function(){var re=/./;return re.exec=function(){var result=[];return result.groups={a:"7"},result},"7"!=="".replace(re,"$<a>")})),SPLIT_WORKS_WITH_OVERWRITTEN_EXEC=function(){var re=/(?:)/,originalExec=re.exec;re.exec=function(){return originalExec.apply(this,arguments)};var result="ab".split(re);return 2===result.length&&"a"===result[0]&&"b"===result[1]}(),_fixReWks=function(KEY,length,exec){var SYMBOL=_wks(KEY),DELEGATES_TO_SYMBOL=!_fails((function(){var O={};return O[SYMBOL]=function(){return 7},7!=""[KEY](O)})),DELEGATES_TO_EXEC=DELEGATES_TO_SYMBOL?!_fails((function(){var execCalled=!1,re=/a/;return re.exec=function(){return execCalled=!0,null},"split"===KEY&&(re.constructor={},re.constructor[SPECIES$3]=function(){return re}),re[SYMBOL](""),!execCalled})):void 0;if(!DELEGATES_TO_SYMBOL||!DELEGATES_TO_EXEC||"replace"===KEY&&!REPLACE_SUPPORTS_NAMED_GROUPS||"split"===KEY&&!SPLIT_WORKS_WITH_OVERWRITTEN_EXEC){var nativeRegExpMethod=/./[SYMBOL],fns=exec(_defined,SYMBOL,""[KEY],(function(nativeMethod,regexp,str,arg2,forceStringMethod){return regexp.exec===_regexpExec?DELEGATES_TO_SYMBOL&&!forceStringMethod?{done:!0,value:nativeRegExpMethod.call(regexp,str,arg2)}:{done:!0,value:nativeMethod.call(str,regexp,arg2)}:{done:!1}})),strfn=fns[0],rxfn=fns[1];_redefine(String.prototype,KEY,strfn),_hide(RegExp.prototype,SYMBOL,2==length?function(string,arg){return rxfn.call(string,this,arg)}:function(string){return rxfn.call(string,this)})}},$min=Math.min,$push=[].push,SUPPORTS_Y=!_fails((function(){RegExp(4294967295,"y")}));_fixReWks("split",2,(function(defined,SPLIT,$split,maybeCallNative){var internalSplit;return internalSplit="c"=="abbc".split(/(b)*/)[1]||4!="test".split(/(?:)/,-1).length||2!="ab".split(/(?:ab)*/).length||4!=".".split(/(.?)(.?)/).length||".".split(/()()/).length>1||"".split(/.?/).length?function(separator,limit){var string=String(this);if(void 0===separator&&0===limit)return[];if(!_isRegexp(separator))return $split.call(string,separator,limit);for(var match,lastIndex,lastLength,output=[],flags=(separator.ignoreCase?"i":"")+(separator.multiline?"m":"")+(separator.unicode?"u":"")+(separator.sticky?"y":""),lastLastIndex=0,splitLimit=void 0===limit?4294967295:limit>>>0,separatorCopy=new RegExp(separator.source,flags+"g");(match=_regexpExec.call(separatorCopy,string))&&!((lastIndex=separatorCopy.lastIndex)>lastLastIndex&&(output.push(string.slice(lastLastIndex,match.index)),match.length>1&&match.index<string.length&&$push.apply(output,match.slice(1)),lastLength=match[0].length,lastLastIndex=lastIndex,output.length>=splitLimit));)separatorCopy.lastIndex===match.index&&separatorCopy.lastIndex++;return lastLastIndex===string.length?!lastLength&&separatorCopy.test("")||output.push(""):output.push(string.slice(lastLastIndex)),output.length>splitLimit?output.slice(0,splitLimit):output}:"0".split(void 0,0).length?function(separator,limit){return void 0===separator&&0===limit?[]:$split.call(this,separator,limit)}:$split,[function(separator,limit){var O=defined(this),splitter=null==separator?void 0:separator[SPLIT];return void 0!==splitter?splitter.call(separator,O,limit):internalSplit.call(String(O),separator,limit)},function(regexp,limit){var res=maybeCallNative(internalSplit,regexp,this,limit,internalSplit!==$split);if(res.done)return res.value;var rx=_anObject(regexp),S=String(this),C=_speciesConstructor(rx,RegExp),unicodeMatching=rx.unicode,flags=(rx.ignoreCase?"i":"")+(rx.multiline?"m":"")+(rx.unicode?"u":"")+(SUPPORTS_Y?"y":"g"),splitter=new C(SUPPORTS_Y?rx:"^(?:"+rx.source+")",flags),lim=void 0===limit?4294967295:limit>>>0;if(0===lim)return[];if(0===S.length)return null===_regexpExecAbstract(splitter,S)?[S]:[];for(var p=0,q=0,A=[];q<S.length;){splitter.lastIndex=SUPPORTS_Y?q:0;var e,z=_regexpExecAbstract(splitter,SUPPORTS_Y?S:S.slice(q));if(null===z||(e=$min(_toLength(splitter.lastIndex+(SUPPORTS_Y?0:q)),S.length))===p)q=_advanceStringIndex(S,q,unicodeMatching);else{if(A.push(S.slice(p,q)),A.length===lim)return A;for(var i=1;i<=z.length-1;i++)if(A.push(z[i]),A.length===lim)return A;q=p=e}}return A.push(S.slice(p)),A}]}));var _sameValue=Object.is||function(x,y){return x===y?0!==x||1/x==1/y:x!=x&&y!=y};_fixReWks("search",1,(function(defined,SEARCH,$search,maybeCallNative){return[function(regexp){var O=defined(this),fn=null==regexp?void 0:regexp[SEARCH];return void 0!==fn?fn.call(regexp,O):new RegExp(regexp)[SEARCH](String(O))},function(regexp){var res=maybeCallNative($search,regexp,this);if(res.done)return res.value;var rx=_anObject(regexp),S=String(this),previousLastIndex=rx.lastIndex;_sameValue(previousLastIndex,0)||(rx.lastIndex=0);var result=_regexpExecAbstract(rx,S);return _sameValue(rx.lastIndex,previousLastIndex)||(rx.lastIndex=previousLastIndex),null===result?-1:result.index}]}));var Search=function(options){options=options||{},this.ASSET_TYPES={LOCATION:"location",EVENT:"event",CATEGORY:"category"};var scope=this;scope.useSmartSearch=options.smart;var endpoint=options.endpoint||options.baseUrl||(scope.useSmartSearch?"https://api-gateway.mappedin.com/search/":"https://search.mappedin.com/"),venue=options.venue,key=options.key,secret=options.secret,locations=options.locations||[],categories=options.categories||[],SUGGEST_URL=scope.useSmartSearch?"/search":"/suggest",headers={Authorization:"Basic "+btoa(key+":"+secret),"mi-context":"web","mi-session":getSessionID(),"mi-device":getDeviceID()},objToParams=function(obj){return Object.keys(obj).map((function(key){return key+"="+encodeURIComponent(obj[key])})).join("&")},SearchItem=function(data){this.assetType=data.assetType,this.score=data.score||data.strength,this.name=data.name,this.id=data.id,this.description=data.description,scope.useSmartSearch&&(this.strength=data.strength,data.ids&&(this.id=data.ids[0]))},SearchLocation=function(data){SearchItem.call(this,data),this.categories=data.categories,this.logo=data.logo,this.assetType=scope.ASSET_TYPES.LOCATION},SearchCategory=function(data){SearchItem.call(this,data),this.assetType=scope.ASSET_TYPES.CATEGORY},SearchEvent=function(data){SearchItem.call(this,data),this.location=data.location,this.startData=data.startDate,this.endData=data.endDate,this.showDate=data.showDate},SearchResults=function(query,data,options){if(this.query=query,this.total=data.total,this.page=options.pn||1,scope.useSmartSearch){var categoryHits=data.categories,locationHits=data.locations,smartHits={locations:[],categories:[]},uniqueLocations={};locationHits.map((function(hit){hit.ids.forEach((function(id){uniqueLocations[id]||(uniqueLocations[id]=new SearchLocation(_objectSpread2({},hit,{ids:[id]})))}))})),smartHits.locations=Object.values(uniqueLocations),smartHits.categories=categoryHits.map((function(object){return new SearchCategory(object)})),this.hits=smartHits}else this.hits=data.hits.map((function(object){switch(object.assetType){case scope.ASSET_TYPES.LOCATION:return new SearchLocation(object);case scope.ASSET_TYPES.EVENT:return new SearchEvent(object)}}));this.getNextPage=function(){return options.pn+=1,scope.search(query,options)},this.hasNextPage=function(){return options.pn*options.ps<data.total}},Suggestions=function(query,data){this.query=query,this.total=data.total,this.hits=data.hits.map((function(hit){return hit.text}))},SearchResultsFallback=function(query,options){var data=function(query,options){var queryInLowerCase=query.toLowerCase(),locationResults=[],categoryResults=[];if(locations.forEach((function(location){var locationName=location.name.toLowerCase();if(queryInLowerCase.includes(" ")&&locationName.includes(queryInLowerCase))locationResults.push(new SearchLocation(location));else{var words=locationName.split(/\s+/),_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=words[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){if(_step.value.startsWith(queryInLowerCase)){locationResults.push(new SearchLocation(location));break}}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{_iteratorNormalCompletion||null==_iterator.return||_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}})),options.expandCategories){var locationResultIds=locationResults.map((function(result){return result.id}));categories.forEach((function(category){var categoryName=category.name.toLowerCase(),categoryId=category.id;categoryName===queryInLowerCase&&locations.forEach((function(location){location.categories.includes(categoryId)&&!locationResultIds.includes(location.id)&&locationResults.push(new SearchLocation(location))}))}))}else categories.forEach((function(category){var categoryName=category.name.toLowerCase();if(queryInLowerCase.includes(" ")&&categoryName.includes(queryInLowerCase))categoryResults.push(new SearchCategory(category));else{var words=categoryName.split(/\s+/),_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=words[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){if(_step2.value.startsWith(queryInLowerCase)){categoryResults.push(new SearchCategory(category));break}}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{_iteratorNormalCompletion2||null==_iterator2.return||_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}}}));var results=locationResults.concat(categoryResults);return results.sort((function(lhs,rhs){var lhsName=lhs.name,rhsName=rhs.name;return lhsName.localeCompare(rhsName)})),results}(query,options);this.query=query,this.total=data.length,this.hits=data,this.fallbackSearch=!0,this.page=options.pn||1,this.getNextPage=function(){},this.hasNextPage=!1};this.search=function(query,options){(options=options||{}).q=query,scope.useSmartSearch?(options.ln=null==options.ln?20:options.ln,options.cn=null==options.cn?5:options.cn,options.lang=null==options.lang?"en":options.lang):(options.ps=null==options.ps?10:options.ps,options.pn=null==options.pn?1:options.pn);var expandCategories=!1;options.expandCategories&&(expandCategories=options.expandCategories,delete options.expandCategories);var url=endpoint+venue+"/search?"+objToParams(options),reqOptions={method:"GET",mode:"cors",headers:headers};return new Promise((function(resolve,reject){0!=query.length?fetch(url,reqOptions).then((function(response){200!=response.status?reject({message:response.status+" "+response.statusText,response:response}):response.json().then((function(data){resolve(new SearchResults(query,data,options))}),reject)}),reject):reject({message:"Empty Search",response:{}})})).catch((function(e){var fallbackEnabled=locations.length||categories.length,emptySearch=e&&e.message&&"Empty Search"===e.message;if(!fallbackEnabled||emptySearch)throw e;return new SearchResultsFallback(query,_objectSpread2({expandCategories:expandCategories},options))}))},this.suggest=function(query){if(scope.useSmartSearch){console.warn("Smart Search doesn't support the Suggest API; please use the Search API.");return new Suggestions(query,{total:0,hits:[]})}(options={}).q=query.toLowerCase();var url=endpoint+venue+SUGGEST_URL+"?"+objToParams(options),reqOptions={method:"GET",mode:"cors",headers:headers};return new Promise((function(resolve,reject){0!=query.length?fetch(url,reqOptions).then((function(response){200!=response.status?reject({message:response.status+" "+response.statusText,response:response}):response.json().then((function(data){resolve(new Suggestions(query,data))}),reject)}),reject):reject({message:"Empty query",response:{}})})).catch((function(e){return new SearchResultsFallback(query,{expandCategories:!1})}))}},$assign=Object.assign,_objectAssign=!$assign||_fails((function(){var A={},B={},S=Symbol(),K="abcdefghijklmnopqrst";return A[S]=7,K.split("").forEach((function(k){B[k]=k})),7!=$assign({},A)[S]||Object.keys($assign({},B)).join("")!=K}))?function(target,source){for(var T=_toObject(target),aLen=arguments.length,index=1,getSymbols=_objectGops.f,isEnum=_objectPie.f;aLen>index;)for(var key,S=_iobject(arguments[index++]),keys=getSymbols?_objectKeys(S).concat(getSymbols(S)):_objectKeys(S),length=keys.length,j=0;length>j;)key=keys[j++],_descriptors&&!isEnum.call(S,key)||(T[key]=S[key]);return T}:$assign;_export(_export.S+_export.F,"Object",{assign:_objectAssign});var _actions2,_actions3,_actions4,_actions5,_states,STATE,ACTION,MARKERSTATE,PubSub=function(){};function tinyObservable(store){var newStore=store;Object.assign(newStore,PubSub.prototype);var _loop=function(name){var value=newStore[name];if("function"==typeof value)return"continue";newStore["_".concat(name)]=value,Object.defineProperty(newStore,name,{get:function(){return newStore["_".concat(name)]},set:function(value){var oldValue=newStore["_".concat(name)];newStore["_".concat(name)]=value,newStore.publish("".concat(name,"Changed"),{oldValue:oldValue,newValue:newStore[name]})}})};for(var name in newStore)_loop(name);return newStore}Object.assign(PubSub.prototype,{publish:function(eventName,data){this._subscribers&&this._subscribers[eventName]&&this._subscribers[eventName].forEach((function(fn){"function"==typeof fn&&fn(data)}))},on:function(eventName,fn){this._subscribers||(this._subscribers={}),this._subscribers[eventName]=this._subscribers[eventName]||[],this._subscribers[eventName].push(fn)},off:function(eventName,fn){if(this._subscribers&&this._subscribers[eventName]){var itemIdx=this._subscribers[eventName].indexOf(fn);-1!==itemIdx&&this._subscribers[eventName].splice(itemIdx,1)}},destroy:function(){this._subscribers={}}}),function(STATE){STATE[STATE.NOT_LISTENING=0]="NOT_LISTENING",STATE[STATE.LISTENING=1]="LISTENING",STATE[STATE.HAS_POSITION=2]="HAS_POSITION",STATE[STATE.HAS_INDOOR_POSITION=3]="HAS_INDOOR_POSITION",STATE[STATE.LOCATION_UNCERTAIN=4]="LOCATION_UNCERTAIN"}(STATE||(STATE={})),function(ACTION){ACTION[ACTION.gotPosition=0]="gotPosition",ACTION[ACTION.gotPositionWithFloor=1]="gotPositionWithFloor",ACTION[ACTION.gotError=2]="gotError",ACTION[ACTION.timedOut=3]="timedOut",ACTION[ACTION.disabledBlueDot=4]="disabledBlueDot",ACTION[ACTION.enabledBlueDot=5]="enabledBlueDot"}(ACTION||(ACTION={})),function(MARKERSTATE){MARKERSTATE[MARKERSTATE.hidden=0]="hidden",MARKERSTATE[MARKERSTATE.ghost=1]="ghost",MARKERSTATE[MARKERSTATE.normal=2]="normal",MARKERSTATE[MARKERSTATE.uncertain=3]="uncertain"}(MARKERSTATE||(MARKERSTATE={}));var STATEMACHINE_EVENT,states=(_defineProperty(_states={},STATE.NOT_LISTENING,{actions:_defineProperty({},ACTION.enabledBlueDot,STATE.LISTENING)}),_defineProperty(_states,STATE.LISTENING,{actions:(_actions2={},_defineProperty(_actions2,ACTION.gotPosition,STATE.HAS_POSITION),_defineProperty(_actions2,ACTION.gotPositionWithFloor,STATE.HAS_INDOOR_POSITION),_defineProperty(_actions2,ACTION.timedOut,STATE.LOCATION_UNCERTAIN),_defineProperty(_actions2,ACTION.disabledBlueDot,STATE.NOT_LISTENING),_actions2),markerState:MARKERSTATE.hidden}),_defineProperty(_states,STATE.HAS_POSITION,{actions:(_actions3={},_defineProperty(_actions3,ACTION.gotPositionWithFloor,STATE.HAS_INDOOR_POSITION),_defineProperty(_actions3,ACTION.timedOut,STATE.LOCATION_UNCERTAIN),_defineProperty(_actions3,ACTION.gotError,STATE.LISTENING),_defineProperty(_actions3,ACTION.disabledBlueDot,STATE.NOT_LISTENING),_actions3),markerState:MARKERSTATE.ghost}),_defineProperty(_states,STATE.HAS_INDOOR_POSITION,{actions:(_actions4={},_defineProperty(_actions4,ACTION.gotPosition,STATE.HAS_POSITION),_defineProperty(_actions4,ACTION.timedOut,STATE.LOCATION_UNCERTAIN),_defineProperty(_actions4,ACTION.gotError,STATE.LISTENING),_defineProperty(_actions4,ACTION.disabledBlueDot,STATE.NOT_LISTENING),_actions4),markerState:MARKERSTATE.normal}),_defineProperty(_states,STATE.LOCATION_UNCERTAIN,{actions:(_actions5={},_defineProperty(_actions5,ACTION.gotPosition,STATE.HAS_POSITION),_defineProperty(_actions5,ACTION.gotPositionWithFloor,STATE.HAS_INDOOR_POSITION),_defineProperty(_actions5,ACTION.timedOut,STATE.LOCATION_UNCERTAIN),_defineProperty(_actions5,ACTION.gotError,STATE.LISTENING),_defineProperty(_actions5,ACTION.disabledBlueDot,STATE.NOT_LISTENING),_actions5),markerState:MARKERSTATE.uncertain}),_states);!function(STATEMACHINE_EVENT){STATEMACHINE_EVENT[STATEMACHINE_EVENT.stateChanged=0]="stateChanged",STATEMACHINE_EVENT[STATEMACHINE_EVENT.markerStateChanged=1]="markerStateChanged"}(STATEMACHINE_EVENT||(STATEMACHINE_EVENT={}));_export(_export.S,"Number",{MAX_SAFE_INTEGER:9007199254740991});var isOutsideMap=function(position,maps){var targetMap=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,multiplier=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1.5,targetMaps=targetMap?[targetMap]:maps,foundWithinMap=!1;return targetMaps.forEach((function(map){Math.abs(position.x)<map.width*multiplier&&Math.abs(position.y)<map.height*multiplier&&(foundWithinMap=!0)})),!foundWithinMap};function _defineProperties$1(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}
/**
* KalmanFilter
* @class
* @author Wouter Bulten
* @see {@link http://github.com/wouterbulten/kalmanjs}
* @version Version: 1.0.0-beta
* @copyright Copyright 2015-2018 Wouter Bulten
* @license MIT License
* @preserve
*/
var kalman=function(){function KalmanFilter(){var _ref=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},_ref$R=_ref.R,R=void 0===_ref$R?1:_ref$R,_ref$Q=_ref.Q,Q=void 0===_ref$Q?1:_ref$Q,_ref$A=_ref.A,A=void 0===_ref$A?1:_ref$A,_ref$B=_ref.B,B=void 0===_ref$B?0:_ref$B,_ref$C=_ref.C,C=void 0===_ref$C?1:_ref$C;!function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,KalmanFilter),this.R=R,this.Q=Q,this.A=A,this.C=C,this.B=B,this.cov=NaN,this.x=NaN}var Constructor,protoProps,staticProps;return Constructor=KalmanFilter,(protoProps=[{key:"filter",value:function(z){var u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(isNaN(this.x))this.x=1/this.C*z,this.cov=1/this.C*this.Q*(1/this.C);else{var predX=this.predict(u),predCov=this.uncertainty(),K=predCov*this.C*(1/(this.C*predCov*this.C+this.Q));this.x=predX+K*(z-this.C*predX),this.cov=predCov-K*this.C*predCov}return this.x}},{key:"predict",value:function(){var u=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.A*this.x+this.B*u}},{key:"uncertainty",value:function(){return this.A*this.cov*this.A+this.R}},{key:"lastMeasurement",value:function(){return this.x}},{key:"setMeasurementNoise",value:function(noise){this.Q=noise}},{key:"setProcessNoise",value:function(noise){this.R=noise}}])&&_defineProperties$1(Constructor.prototype,protoProps),staticProps&&_defineProperties$1(Constructor,staticProps),KalmanFilter}();function isValidLevel(level){return null===level||"number"==typeof level}var GEOLOCATION_STATUS,LevelFilter=function(){function LevelFilter(){var inertia=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2;_classCallCheck(this,LevelFilter),this.nextLevel=void 0,this.inertia=inertia,this.levelConfirmations=0}return _createClass(LevelFilter,[{key:"_resetConfirmations",value:function(){this.levelConfirmations=0,this.nextLevel=void 0}},{key:"_resetFilter",value:function(){this._resetConfirmations(),this.previousLevel=void 0}},{key:"filter",value:function(lvl){var result=null,level=void 0===lvl?null:lvl;if(!isValidLevel(level))throw new TypeError("The argument given to filter() must be null, undefined, or a number");return null===level?this._resetFilter():(isValidLevel(this.previousLevel)&&level!==this.previousLevel?isValidLevel(this.nextLevel)&&level===this.nextLevel?this.levelConfirmations>=this.inertia?(this._resetConfirmations(),result=level):(this.levelConfirmations++,result=this.previousLevel):(this.levelConfirmations++,this.nextLevel=level,result=this.previousLevel):result=level,this.previousLevel=result),result}}]),LevelFilter}(),SMOOTHING_TYPE={NONE:"none",KALMAN:"kalman"},PositionSmoothing=function(){function PositionSmoothing(levelFilter){_classCallCheck(this,PositionSmoothing),this.smooth=this.smooth.bind(this),this.smoothingType=window.mappedin&&window.mappedin.smoothingType||SMOOTHING_TYPE.KALMAN,this.lastLocation=null,this.levelFilter=levelFilter}return _createClass(PositionSmoothing,[{key:"formatLocation",value:function(pos){return{type:"SUCCESS",timestamp:pos.timestamp,coords:{latitude:pos.latitude,longitude:pos.longitude,accuracy:pos.accuracy,floorLevel:this.levelFilter.filter(pos.floorLevel)}}}},{key:"kalman",value:function(location,lastLocation){if(lastLocation){var processNoise=1.4*(location.timestamp-lastLocation.timestamp)/1e3;this.latitudeKF.setProcessNoise(processNoise),this.longitudeKF.setProcessNoise(processNoise),this.latitudeKF.setMeasurementNoise(location.accuracy),this.longitudeKF.setMeasurementNoise(location.accuracy)}else this.latitudeKF=new kalman({R:1,Q:location.accuracy}),this.longitudeKF=new kalman({R:1,Q:location.accuracy});return _objectSpread2({},location,{latitude:this.latitudeKF.filter(location.latitude),longitude:this.longitudeKF.filter(location.longitude)})}},{key:"setSmoothingType",value:function(smoothingType){this.smoothingType=smoothingType}},{key:"smooth",value:function(pos){var smoothPos;switch(this.smoothingType){case SMOOTHING_TYPE.KALMAN:return smoothPos=this.kalman(function(pos){return{floorLevel:pos.coords.floorLevel,timestamp:pos.timestamp,latitude:pos.coords.latitude,longitude:pos.coords.longitude,accuracy:pos.coords.accuracy,speed:-1,type:pos.type}}(pos),this.lastLocation),this.lastLocation=smoothPos,this.formatLocation(smoothPos);case SMOOTHING_TYPE.NONE:default:return pos}}},{key:"reset",value:function(){this.lastLocation=null,this.levelFilter=new LevelFilter(this.levelFilter.inertia)}}]),PositionSmoothing}(),toRadians=function(degrees){return degrees*Math.PI/180},BlueDotBearing=function(){var bearingTimer,store=tinyObservable({bearingExpired:!1,previousLat:null,previousLong:null,calculateHeading:function(lat,long,userPosition){store.previousLat||(store.previousLat=lat),store.previousLong||(store.previousLong=long);var deltaLat=store.previousLat-lat,deltaLong=store.previousLong-long,delta=Math.pow(Math.pow(deltaLat,2)+Math.pow(deltaLong,2),.5),sufficientAccuracy=userPosition&&userPosition.coords.accuracy<20,sufficientChange=parseInt(delta.toFixed(5))>0;if(sufficientAccuracy&&sufficientChange){store.resetBearingExpirationTimer();var bearing=store.getBearing([store.previousLat,store.previousLong],[lat,long]);return store.previousLat=lat,store.previousLong=long,bearing}return!1},getBearing:function(_ref,_ref2){var _ref3=_slicedToArray(_ref,2),startLatDeg=_ref3[0],startLngDeg=_ref3[1],_ref4=_slicedToArray(_ref2,2),destLatDeg=_ref4[0],destLngDeg=_ref4[1],startLat=toRadians(startLatDeg),startLng=toRadians(startLngDeg),destLat=toRadians(destLatDeg),destLng=toRadians(destLngDeg),y=Math.sin(destLng-startLng)*Math.cos(destLat),x=Math.cos(startLat)*Math.sin(destLat)-Math.sin(startLat)*Math.cos(destLat)*Math.cos(destLng-startLng),brng=Math.atan2(y,x);return((brng=180*brng/Math.PI)+360)%360},resetBearingExpirationTimer:function(){null!==bearingTimer&&store.clearBearingExpirationTimer(),bearingTimer=setTimeout((function(){store.bearingExpired=!0,store.clearBearingExpirationTimer()}),5e3)},clearBearingExpirationTimer:function(){null!==bearingTimer&&(clearTimeout(bearingTimer),bearingTimer=null)}});return store};!function(GEOLOCATION_STATUS){GEOLOCATION_STATUS[GEOLOCATION_STATUS.SUCCESS=0]="SUCCESS"}(GEOLOCATION_STATUS||(GEOLOCATION_STATUS={}));for(var Typed,BlueDot=function(_ref){var fallbackToGPSTimer,latestGPSFallbackPosition,locationUncertainTimer,watcherID,data=_ref.data,mapView=_ref.mapView,maps=data.maps,venue=data.venue,geolocationSource=navigator.geolocation,geolocationOpts={enableHighAccuracy:!0},stateMachine=function(){var store=tinyObservable({state:STATE.NOT_LISTENING,markerState:MARKERSTATE.hidden,transition:function(actionName){if(null!=states[store.state]){var result=states[store.state].actions[actionName];null!=result&&store.state!==result&&(store.state=result,store.markerState=states[store.state].markerState)}},reset:function(){store.state=STATE.NOT_LISTENING}});return store}(),isMultifloor=maps.length>1,hasGottenFloorLevel=!1,blueDotBearing=BlueDotBearing();blueDotBearing.on("bearingExpiredChanged",(function(change){change.newValue&&(store.bearing=null,updateInternalState(store.userPosition,null))}));var setError=function(message){store.error=message,"string"==typeof message&&(store.stateMachine.transition(ACTION.gotError),updateInternalState(null,null))},updateInternalState=function(position,map){if(store.userPosition=position,null!=map){store.userMap=map;var nodesOnCurrentMap=data.nodes.filter((function(node){return node.map===map.id&&node.paths.length})),mapPosition=mapView.getPositionLatLon(position.coords.latitude,position.coords.longitude),nearestNode=function(nodes,position){var nearestNode,x1,y1,x2=position.x,y2=position.y,min=Number.MAX_SAFE_INTEGER;return nodes.forEach((function(node){x1=node.x,y1=node.y;var distance=Math.sqrt(Math.pow(x2-x1,2)+Math.pow(y2-y1,2));distance<min&&(min=distance,nearestNode=node)})),nearestNode}(nodesOnCurrentMap,{x:mapPosition.x+map.width/2,y:-mapPosition.y+map.height/2});store.nearestNode=nearestNode}store.userData={state:stateMachine.state,position:store.userPosition,map:store.userMap,bearing:store.bearing,nearestNode:store.nearestNode,error:store.error}},onPositionReceived=function(position){var floorLevel=position.coords.floorLevel;void 0!==window.floorLevel&&(floorLevel=window.floorLevel);var modifiedPosition={timestamp:position.timestamp,type:position.type,coords:{accuracy:position.coords.accuracy,latitude:position.coords.latitude,longitude:position.coords.longitude,floorLevel:floorLevel}};null!=floorLevel&&(hasGottenFloorLevel=!0),window.mappedin&&(Array.isArray(window.mappedin.bluedotCaptureData)?window.mappedin.bluedotCaptureData.push(modifiedPosition):window.mappedin.bluedotCaptureData=[modifiedPosition]),locationUncertainTimer&&clearTimeout(locationUncertainTimer),locationUncertainTimer=setTimeout((function(){stateMachine.transition(ACTION.timedOut),setError(null),store.positionSmoothing.reset(),updateInternalState(store.userPosition,null)}),store.locationUncertainTimeoutPeriod);var mapPosition=mapView.getPositionLatLon(modifiedPosition.coords.latitude,modifiedPosition.coords.longitude),outsideMap=isOutsideMap(mapPosition,maps);if(null!=modifiedPosition.coords.latitude&&null!=modifiedPosition.coords.longitude)if(outsideMap)store.positionSmoothing.reset();else{var smoothedPosition=store.positionSmoothing.smooth(modifiedPosition);floorLevel=smoothedPosition.coords.floorLevel;var lat=smoothedPosition.coords.latitude,lon=smoothedPosition.coords.longitude,newBearing=blueDotBearing.calculateHeading(lat,lon,smoothedPosition);!1!==newBearing&&(store.bearing=newBearing);var targetMap=null;if("hudson-yards"===venue.slug){var currentMapData=store.userMap;if(null==floorLevel&&isOutsideMap(mapPosition,maps,currentMapData,.55)&&(targetMap=maps.filter((function(map){return"5b5f5becadd5444692000001"===map.id}))[0]),null!=floorLevel){var candidateMaps=maps.filter((function(map){return map.elevation===floorLevel}));candidateMaps.length>1&&(candidateMaps=candidateMaps.filter((function(map){return"5b5f20e3f3ea231068000000"===map.group}))),targetMap=candidateMaps[0]}}if(!targetMap&&null!=floorLevel){var _candidateMaps=maps.filter((function(map){return map.elevation===floorLevel}));1===_candidateMaps.length&&(targetMap=_candidateMaps[0])}if(setError(null),store.forceBlueDot&&store.userMap&&!hasGottenFloorLevel&&(targetMap=store.userMap),targetMap||store.forceBlueDot&&stateMachine.state!==STATE.HAS_INDOOR_POSITION||!store.forceBlueDot&&!isMultifloor)stateMachine.transition(ACTION.gotPositionWithFloor),setError(null),null!=fallbackToGPSTimer&&(clearTimeout(fallbackToGPSTimer),fallbackToGPSTimer=null);else{if(stateMachine.state===STATE.HAS_INDOOR_POSITION)return latestGPSFallbackPosition=_objectSpread2({},smoothedPosition),void(null==fallbackToGPSTimer&&(fallbackToGPSTimer=setTimeout((function(){stateMachine.transition(ACTION.gotPosition),updateInternalState(latestGPSFallbackPosition,targetMap),fallbackToGPSTimer=null}),store.fallbackToGPSTimeoutPeriod)));stateMachine.transition(ACTION.gotPosition)}updateInternalState(smoothedPosition,targetMap)}else store.positionSmoothing.reset()},store=tinyObservable({positionSmoothing:new PositionSmoothing(new LevelFilter),locationUncertainTimeoutPeriod:3e4,fallbackToGPSTimeoutPeriod:1e4,userMap:maps.find((function(map){return map.id===venue.defaultMap})),userPosition:null,nearestNode:null,error:null,userData:null,stateMachine:stateMachine,enableBlueDot:function(options){options&&(store.forceBlueDot=options.allowImplicitFloorLevel),null==watcherID&&(stateMachine.transition(ACTION.enabledBlueDot),watcherID=geolocationSource.watchPosition(onPositionReceived,(function(err){setError("position-error"),console.warn("ERROR(".concat(err.code,"): ").concat(err.message))}),geolocationOpts))},disableBlueDot:function(){geolocationSource.clearWatch(watcherID),watcherID=null,stateMachine.transition(ACTION.disabledBlueDot)}});return store},TYPED=_uid("typed_array"),VIEW=_uid("view"),ABV=!(!_global.ArrayBuffer||!_global.DataView),CONSTR=ABV,i$2=0,TypedArrayConstructors="Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array".split(",");i$2<9;)(Typed=_global[TypedArrayConstructors[i$2++]])?(_hide(Typed.prototype,TYPED,!0),_hide(Typed.prototype,VIEW,!0)):CONSTR=!1;var _typed={ABV:ABV,CONSTR:CONSTR,TYPED:TYPED,VIEW:VIEW},_toIndex=function(it){if(void 0===it)return 0;var number=_toInteger(it),length=_toLength(number);if(number!==length)throw RangeError("Wrong length!");return length},_arrayFill=function(value){for(var O=_toObject(this),length=_toLength(O.length),aLen=arguments.length,index=_toAbsoluteIndex(aLen>1?arguments[1]:void 0,length),end=aLen>2?arguments[2]:void 0,endPos=void 0===end?length:_toAbsoluteIndex(end,length);endPos>index;)O[index++]=value;return O},_typedBuffer=createCommonjsModule((function(module,exports){var gOPN=_objectGopn.f,dP=_objectDp.f,PROTOTYPE="prototype",WRONG_INDEX="Wrong index!",$ArrayBuffer=_global.ArrayBuffer,$DataView=_global.DataView,Math=_global.Math,RangeError=_global.RangeError,Infinity=_global.Infinity,BaseBuffer=$ArrayBuffer,abs=Math.abs,pow=Math.pow,floor=Math.floor,log=Math.log,LN2=Math.LN2,$BUFFER=_descriptors?"_b":"buffer",$LENGTH=_descriptors?"_l":"byteLength",$OFFSET=_descriptors?"_o":"byteOffset";function packIEEE754(value,mLen,nBytes){var e,m,c,buffer=new Array(nBytes),eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,rt=23===mLen?pow(2,-24)-pow(2,-77):0,i=0,s=value<0||0===value&&1/value<0?1:0;for((value=abs(value))!=value||value===Infinity?(m=value!=value?1:0,e=eMax):(e=floor(log(value)/LN2),value*(c=pow(2,-e))<1&&(e--,c*=2),(value+=e+eBias>=1?rt/c:rt*pow(2,1-eBias))*c>=2&&(e++,c/=2),e+eBias>=eMax?(m=0,e=eMax):e+eBias>=1?(m=(value*c-1)*pow(2,mLen),e+=eBias):(m=value*pow(2,eBias-1)*pow(2,mLen),e=0));mLen>=8;buffer[i++]=255&m,m/=256,mLen-=8);for(e=e<<mLen|m,eLen+=mLen;eLen>0;buffer[i++]=255&e,e/=256,eLen-=8);return buffer[--i]|=128*s,buffer}function unpackIEEE754(buffer,mLen,nBytes){var m,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,nBits=eLen-7,i=nBytes-1,s=buffer[i--],e=127&s;for(s>>=7;nBits>0;e=256*e+buffer[i],i--,nBits-=8);for(m=e&(1<<-nBits)-1,e>>=-nBits,nBits+=mLen;nBits>0;m=256*m+buffer[i],i--,nBits-=8);if(0===e)e=1-eBias;else{if(e===eMax)return m?NaN:s?-Infinity:Infinity;m+=pow(2,mLen),e-=eBias}return(s?-1:1)*m*pow(2,e-mLen)}function unpackI32(bytes){return bytes[3]<<24|bytes[2]<<16|bytes[1]<<8|bytes[0]}function packI8(it){return[255&it]}function packI16(it){return[255&it,it>>8&255]}function packI32(it){return[255&it,it>>8&255,it>>16&255,it>>24&255]}function packF64(it){return packIEEE754(it,52,8)}function packF32(it){return packIEEE754(it,23,4)}function addGetter(C,key,internal){dP(C[PROTOTYPE],key,{get:function(){return this[internal]}})}function get(view,bytes,index,isLittleEndian){var intIndex=_toIndex(+index);if(intIndex+bytes>view[$LENGTH])throw RangeError(WRONG_INDEX);var store=view[$BUFFER]._b,start=intIndex+view[$OFFSET],pack=store.slice(start,start+bytes);return isLittleEndian?pack:pack.reverse()}function set(view,bytes,index,conversion,value,isLittleEndian){var intIndex=_toIndex(+index);if(intIndex+bytes>view[$LENGTH])throw RangeError(WRONG_INDEX);for(var store=view[$BUFFER]._b,start=intIndex+view[$OFFSET],pack=conversion(+value),i=0;i<bytes;i++)store[start+i]=pack[isLittleEndian?i:bytes-i-1]}if(_typed.ABV){if(!_fails((function(){$ArrayBuffer(1)}))||!_fails((function(){new $ArrayBuffer(-1)}))||_fails((function(){return new $ArrayBuffer,new $ArrayBuffer(1.5),new $ArrayBuffer(NaN),"ArrayBuffer"!=$ArrayBuffer.name}))){for(var key,ArrayBufferProto=($ArrayBuffer=function(length){return _anInstance(this,$ArrayBuffer),new BaseBuffer(_toIndex(length))})[PROTOTYPE]=BaseBuffer[PROTOTYPE],keys=gOPN(BaseBuffer),j=0;keys.length>j;)(key=keys[j++])in $ArrayBuffer||_hide($ArrayBuffer,key,BaseBuffer[key]);ArrayBufferProto.constructor=$ArrayBuffer}var view=new $DataView(new $ArrayBuffer(2)),$setInt8=$DataView[PROTOTYPE].setInt8;view.setInt8(0,2147483648),view.setInt8(1,2147483649),!view.getInt8(0)&&view.getInt8(1)||_redefineAll($DataView[PROTOTYPE],{setInt8:function(byteOffset,value){$setInt8.call(this,byteOffset,value<<24>>24)},setUint8:function(byteOffset,value){$setInt8.call(this,byteOffset,value<<24>>24)}},!0)}else $ArrayBuffer=function(length){_anInstance(this,$ArrayBuffer,"ArrayBuffer");var byteLength=_toIndex(length);this._b=_arrayFill.call(new Array(byteLength),0),this[$LENGTH]=byteLength},$DataView=function(buffer,byteOffset,byteLength){_anInstance(this,$DataView,"DataView"),_anInstance(buffer,$ArrayBuffer,"DataView");var bufferLength=buffer[$LENGTH],offset=_toInteger(byteOffset);if(offset<0||offset>bufferLength)throw RangeError("Wrong offset!");if(offset+(byteLength=void 0===byteLength?bufferLength-offset:_toLength(byteLength))>bufferLength)throw RangeError("Wrong length!");this[$BUFFER]=buffer,this[$OFFSET]=offset,this[$LENGTH]=byteLength},_descriptors&&(addGetter($ArrayBuffer,"byteLength","_l"),addGetter($DataView,"buffer","_b"),addGetter($DataView,"byteLength","_l"),addGetter($DataView,"byteOffset","_o")),_redefineAll($DataView[PROTOTYPE],{getInt8:function(byteOffset){return get(this,1,byteOffset)[0]<<24>>24},getUint8:function(byteOffset){return get(this,1,byteOffset)[0]},getInt16:function(byteOffset){var bytes=get(this,2,byteOffset,arguments[1]);return(bytes[1]<<8|bytes[0])<<16>>16},getUint16:function(byteOffset){var bytes=get(this,2,byteOffset,arguments[1]);return bytes[1]<<8|bytes[0]},getInt32:function(byteOffset){return unpackI32(get(this,4,byteOffset,arguments[1]))},getUint32:function(byteOffset){return unpackI32(get(this,4,byteOffset,arguments[1]))>>>0},getFloat32:function(byteOffset){return unpackIEEE754(get(this,4,byteOffset,arguments[1]),23,4)},getFloat64:function(byteOffset){return unpackIEEE754(get(this,8,byteOffset,arguments[1]),52,8)},setInt8:function(byteOffset,value){set(this,1,byteOffset,packI8,value)},setUint8:function(byteOffset,value){set(this,1,byteOffset,packI8,value)},setInt16:function(byteOffset,value){set(this,2,byteOffset,packI16,value,arguments[2])},setUint16:function(byteOffset,value){set(this,2,byteOffset,packI16,value,arguments[2])},setInt32:function(byteOffset,value){set(this,4,byteOffset,packI32,value,arguments[2])},setUint32:function(byteOffset,value){set(this,4,byteOffset,packI32,value,arguments[2])},setFloat32:function(byteOffset,value){set(this,4,byteOffset,packF32,value,arguments[2])},setFloat64:function(byteOffset,value){set(this,8,byteOffset,packF64,value,arguments[2])}});_setToStringTag($ArrayBuffer,"ArrayBuffer"),_setToStringTag($DataView,"DataView"),_hide($DataView[PROTOTYPE],_typed.VIEW,!0),exports.ArrayBuffer=$ArrayBuffer,exports.DataView=$DataView})),_arrayCopyWithin=[].copyWithin||function(target,start){var O=_toObject(this),len=_toLength(O.length),to=_toAbsoluteIndex(target,len),from=_toAbsoluteIndex(start,len),end=arguments.length>2?arguments[2]:void 0,count=Math.min((void 0===end?len:_toAbsoluteIndex(end,len))-from,len-to),inc=1;for(from<to&&to<from+count&&(inc=-1,from+=count-1,to+=count-1);count-- >0;)from in O?O[to]=O[from]:delete O[to],to+=inc,from+=inc;return O};createCommonjsModule((function(module){if(_descriptors){var global=_global,fails=_fails,$export=_export,$typed=_typed,$buffer=_typedBuffer,ctx=_ctx,anInstance=_anInstance,propertyDesc=_propertyDesc,hide=_hide,redefineAll=_redefineAll,toInteger=_toInteger,toLength=_toLength,toIndex=_toIndex,toAbsoluteIndex=_toAbsoluteIndex,toPrimitive=_toPrimitive,has=_has,classof=_classof,isObject=_isObject,toObject=_toObject,isArrayIter=_isArrayIter,create=_objectCreate,getPrototypeOf=_objectGpo,gOPN=_objectGopn.f,getIterFn=core_getIteratorMethod,uid=_uid,wks=_wks,createArrayMethod=_arrayMethods,createArrayIncludes=_arrayIncludes,speciesConstructor=_speciesConstructor,ArrayIterators=es6_array_iterator,Iterators=_iterators,$iterDetect=_iterDetect,setSpecies=_setSpecies,arrayFill=_arrayFill,arrayCopyWithin=_arrayCopyWithin,$DP=_objectDp,$GOPD=_objectGopd,dP=$DP.f,gOPD=$GOPD.f,RangeError=global.RangeError,TypeError=global.TypeError,Uint8Array=global.Uint8Array,ArrayProto=Array.prototype,$ArrayBuffer=$buffer.ArrayBuffer,$DataView=$buffer.DataView,arrayForEach=createArrayMethod(0),arrayFilter=createArrayMethod(2),arraySome=createArrayMethod(3),arrayEvery=createArrayMethod(4),arrayFind=createArrayMethod(5),arrayFindIndex=createArrayMethod(6),arrayIncludes=createArrayIncludes(!0),arrayIndexOf=createArrayIncludes(!1),arrayValues=ArrayIterators.values,arrayKeys=ArrayIterators.keys,arrayEntries=ArrayIterators.entries,arrayLastIndexOf=ArrayProto.lastIndexOf,arrayReduce=ArrayProto.reduce,arrayReduceRight=ArrayProto.reduceRight,arrayJoin=ArrayProto.join,arraySort=ArrayProto.sort,arraySlice=ArrayProto.slice,arrayToString=ArrayProto.toString,arrayToLocaleString=ArrayProto.toLocaleString,ITERATOR=wks("iterator"),TAG=wks("toStringTag"),TYPED_CONSTRUCTOR=uid("typed_constructor"),DEF_CONSTRUCTOR=uid("def_constructor"),ALL_CONSTRUCTORS=$typed.CONSTR,TYPED_ARRAY=$typed.TYPED,VIEW=$typed.VIEW,$map=createArrayMethod(1,(function(O,length){return allocate(speciesConstructor(O,O[DEF_CONSTRUCTOR]),length)})),LITTLE_ENDIAN=fails((function(){return 1===new Uint8Array(new Uint16Array([1]).buffer)[0]})),FORCED_SET=!!Uint8Array&&!!Uint8Array.prototype.set&&fails((function(){new Uint8Array(1).set({})})),toOffset=function(it,BYTES){var offset=toInteger(it);if(offset<0||offset%BYTES)throw RangeError("Wrong offset!");return offset},validate=function(it){if(isObject(it)&&TYPED_ARRAY in it)return it;throw TypeError(it+" is not a typed array!")},allocate=function(C,length){if(!(isObject(C)&&TYPED_CONSTRUCTOR in C))throw TypeError("It is not a typed array constructor!");return new C(length)},speciesFromList=function(O,list){return fromList(speciesConstructor(O,O[DEF_CONSTRUCTOR]),list)},fromList=function(C,list){for(var index=0,length=list.length,result=allocate(C,length);length>index;)result[index]=list[index++];return result},addGetter=function(it,key,internal){dP(it,key,{get:function(){return this._d[internal]}})},$from=function(source){var i,length,values,result,step,iterator,O=toObject(source),aLen=arguments.length,mapfn=aLen>1?arguments[1]:void 0,mapping=void 0!==mapfn,iterFn=getIterFn(O);if(null!=iterFn&&!isArrayIter(iterFn)){for(iterator=iterFn.call(O),values=[],i=0;!(step=iterator.next()).done;i++)values.push(step.value);O=values}for(mapping&&aLen>2&&(mapfn=ctx(mapfn,arguments[2],2)),i=0,length=toLength(O.length),result=allocate(this,length);length>i;i++)result[i]=mapping?mapfn(O[i],i):O[i];return result},$of=function(){for(var index=0,length=arguments.length,result=allocate(this,length);length>index;)result[index]=arguments[index++];return result},TO_LOCALE_BUG=!!Uint8Array&&fails((function(){arrayToLocaleString.call(new Uint8Array(1))})),$toLocaleString=function(){return arrayToLocaleString.apply(TO_LOCALE_BUG?arraySlice.call(validate(this)):validate(this),arguments)},proto={copyWithin:function(target,start){return arrayCopyWithin.call(validate(this),target,start,arguments.length>2?arguments[2]:void 0)},every:function(callbackfn){return arrayEvery(validate(this),callbackfn,arguments.length>1?arguments[1]:void 0)},fill:function(value){return arrayFill.apply(validate(this),arguments)},filter:function(callbackfn){return speciesFromList(this,arrayFilter(validate(this),callbackfn,arguments.length>1?arguments[1]:void 0))},find:function(predicate){return arrayFind(validate(this),predicate,arguments.length>1?arguments[1]:void 0)},findIndex:function(predicate){return arrayFindIndex(validate(this),predicate,arguments.length>1?arguments[1]:void 0)},forEach:function(callbackfn){arrayForEach(validate(this),callbackfn,arguments.length>1?arguments[1]:void 0)},indexOf:function(searchElement){return arrayIndexOf(validate(this),searchElement,arguments.length>1?arguments[1]:void 0)},includes:function(searchElement){return arrayIncludes(validate(this),searchElement,arguments.length>1?arguments[1]:void 0)},join:function(separator){return arrayJoin.apply(validate(this),arguments)},lastIndexOf:function(searchElement){return arrayLastIndexOf.apply(validate(this),arguments)},map:function(mapfn){return $map(validate(this),mapfn,arguments.length>1?arguments[1]:void 0)},reduce:function(callbackfn){return arrayReduce.apply(validate(this),arguments)},reduceRight:function(callbackfn){return arrayReduceRight.apply(validate(this),arguments)},reverse:function(){for(var value,length=validate(this).length,middle=Math.floor(length/2),index=0;index<middle;)value=this[index],this[index++]=this[--length],this[length]=value;return this},some:function(callbackfn){return arraySome(validate(this),callbackfn,arguments.length>1?arguments[1]:void 0)},sort:function(comparefn){return arraySort.call(validate(this),comparefn)},subarray:function(begin,end){var O=validate(this),length=O.length,$begin=toAbsoluteIndex(begin,length);return new(speciesConstructor(O,O[DEF_CONSTRUCTOR]))(O.buffer,O.byteOffset+$begin*O.BYTES_PER_ELEMENT,toLength((void 0===end?length:toAbsoluteIndex(end,length))-$begin))}},$slice=function(start,end){return speciesFromList(this,arraySlice.call(validate(this),start,end))},$set=function(arrayLike){validate(this);var offset=toOffset(arguments[1],1),length=this.length,src=toObject(arrayLike),len=toLength(src.length),index=0;if(len+offset>length)throw RangeError("Wrong length!");for(;index<len;)this[offset+index]=src[index++]},$iterators={entries:function(){return arrayEntries.call(validate(this))},keys:function(){return arrayKeys.call(validate(this))},values:function(){return arrayValues.call(validate(this))}},isTAIndex=function(target,key){return isObject(target)&&target[TYPED_ARRAY]&&"symbol"!=typeof key&&key in target&&String(+key)==String(key)},$getDesc=function(target,key){return isTAIndex(target,key=toPrimitive(key,!0))?propertyDesc(2,target[key]):gOPD(target,key)},$setDesc=function(target,key,desc){return!(isTAIndex(target,key=toPrimitive(key,!0))&&isObject(desc)&&has(desc,"value"))||has(desc,"get")||has(desc,"set")||desc.configurable||has(desc,"writable")&&!desc.writable||has(desc,"enumerable")&&!desc.enumerable?dP(target,key,desc):(target[key]=desc.value,target)};ALL_CONSTRUCTORS||($GOPD.f=$getDesc,$DP.f=$setDesc),$export($export.S+$export.F*!ALL_CONSTRUCTORS,"Object",{getOwnPropertyDescriptor:$getDesc,defineProperty:$setDesc}),fails((function(){arrayToString.call({})}))&&(arrayToString=arrayToLocaleString=function(){return arrayJoin.call(this)});var $TypedArrayPrototype$=redefineAll({},proto);redefineAll($TypedArrayPrototype$,$iterators),hide($TypedArrayPrototype$,ITERATOR,$iterators.values),redefineAll($TypedArrayPrototype$,{slice:$slice,set:$set,constructor:function(){},toString:arrayToString,toLocaleString:$toLocaleString}),addGetter($TypedArrayPrototype$,"buffer","b"),addGetter($TypedArrayPrototype$,"byteOffset","o"),addGetter($TypedArrayPrototype$,"byteLength","l"),addGetter($TypedArrayPrototype$,"length","e"),dP($TypedArrayPrototype$,TAG,{get:function(){return this[TYPED_ARRAY]}}),module.exports=function(KEY,BYTES,wrapper,CLAMPED){var NAME=KEY+((CLAMPED=!!CLAMPED)?"Clamped":"")+"Array",GETTER="get"+KEY,SETTER="set"+KEY,TypedArray=global[NAME],Base=TypedArray||{},TAC=TypedArray&&getPrototypeOf(TypedArray),FORCED=!TypedArray||!$typed.ABV,O={},TypedArrayPrototype=TypedArray&&TypedArray.prototype,addElement=function(that,index){dP(that,index,{get:function(){return function(that,index){var data=that._d;return data.v[GETTER](index*BYTES+data.o,LITTLE_ENDIAN)}(this,index)},set:function(value){return function(that,index,value){var data=that._d;CLAMPED&&(value=(value=Math.round(value))<0?0:value>255?255:255&value),data.v[SETTER](index*BYTES+data.o,value,LITTLE_ENDIAN)}(this,index,value)},enumerable:!0})};FORCED?(TypedArray=wrapper((function(that,data,$offset,$length){anInstance(that,TypedArray,NAME,"_d");var buffer,byteLength,length,klass,index=0,offset=0;if(isObject(data)){if(!(data instanceof $ArrayBuffer||"ArrayBuffer"==(klass=classof(data))||"SharedArrayBuffer"==klass))return TYPED_ARRAY in data?fromList(TypedArray,data):$from.call(TypedArray,data);buffer=data,offset=toOffset($offset,BYTES);var $len=data.byteLength;if(void 0===$length){if($len%BYTES)throw RangeError("Wrong length!");if((byteLength=$len-offset)<0)throw RangeError("Wrong length!")}else if((byteLength=toLength($length)*BYTES)+offset>$len)throw RangeError("Wrong length!");length=byteLength/BYTES}else length=toIndex(data),buffer=new $ArrayBuffer(byteLength=length*BYTES);for(hide(that,"_d",{b:buffer,o:offset,l:byteLength,e:length,v:new $DataView(buffer)});index<length;)addElement(that,index++)})),TypedArrayPrototype=TypedArray.prototype=create($TypedArrayPrototype$),hide(TypedArrayPrototype,"constructor",TypedArray)):fails((function(){TypedArray(1)}))&&fails((function(){new TypedArray(-1)}))&&$iterDetect((function(iter){new TypedArray,new TypedArray(null),new TypedArray(1.5),new TypedArray(iter)}),!0)||(TypedArray=wrapper((function(that,data,$offset,$length){var klass;return anInstance(that,TypedArray,NAME),isObject(data)?data instanceof $ArrayBuffer||"ArrayBuffer"==(klass=classof(data))||"SharedArrayBuffer"==klass?void 0!==$length?new Base(data,toOffset($offset,BYTES),$length):void 0!==$offset?new Base(data,toOffset($offset,BYTES)):new Base(data):TYPED_ARRAY in data?fromList(TypedArray,data):$from.call(TypedArray,data):new Base(toIndex(data))})),arrayForEach(TAC!==Function.prototype?gOPN(Base).concat(gOPN(TAC)):gOPN(Base),(function(key){key in TypedArray||hide(TypedArray,key,Base[key])})),TypedArray.prototype=TypedArrayPrototype,TypedArrayPrototype.constructor=TypedArray);var $nativeIterator=TypedArrayPrototype[ITERATOR],CORRECT_ITER_NAME=!!$nativeIterator&&("values"==$nativeIterator.name||null==$nativeIterator.name),$iterator=$iterators.values;hide(TypedArray,TYPED_CONSTRUCTOR,!0),hide(TypedArrayPrototype,TYPED_ARRAY,NAME),hide(TypedArrayPrototype,VIEW,!0),hide(TypedArrayPrototype,DEF_CONSTRUCTOR,TypedArray),(CLAMPED?new TypedArray(1)[TAG]==NAME:TAG in TypedArrayPrototype)||dP(TypedArrayPrototype,TAG,{get:function(){return NAME}}),O[NAME]=TypedArray,$export($export.G+$export.W+$export.F*(TypedArray!=Base),O),$export($export.S,NAME,{BYTES_PER_ELEMENT:BYTES}),$export($export.S+$export.F*fails((function(){Base.of.call(TypedArray,1)})),NAME,{from:$from,of:$of}),"BYTES_PER_ELEMENT"in TypedArrayPrototype||hide(TypedArrayPrototype,"BYTES_PER_ELEMENT",BYTES),$export($export.P,NAME,proto),setSpecies(NAME),$export($export.P+$export.F*FORCED_SET,NAME,{set:$set}),$export($export.P+$export.F*!CORRECT_ITER_NAME,NAME,$iterators),TypedArrayPrototype.toString!=arrayToString&&(TypedArrayPrototype.toString=arrayToString),$export($export.P+$export.F*fails((function(){new TypedArray(1).slice()})),NAME,{slice:$slice}),$export($export.P+$export.F*(fails((function(){return[1,2].toLocaleString()!=new TypedArray([1,2]).toLocaleString()}))||!fails((function(){TypedArrayPrototype.toLocaleString.call([1,2])}))),NAME,{toLocaleString:$toLocaleString}),Iterators[NAME]=CORRECT_ITER_NAME?$nativeIterator:$iterator,CORRECT_ITER_NAME||hide(TypedArrayPrototype,ITERATOR,$iterator)}}else module.exports=function(){}}))("Float32",4,(function(init){return function(data,byteOffset,length){return init(this,data,byteOffset,length)}}));var OBJLoader=function(manager){this.manager=void 0!==manager?manager:DefaultLoadingManager,this.materials=null};OBJLoader.prototype={constructor:OBJLoader,load:function(url,onLoad,onProgress,onError){var scope=this,loader=new FileLoader(scope.manager);loader.setPath(this.path),loader.load(url,(function(text){onLoad(scope.parse(text))}),onProgress,onError)},setPath:function(value){this.path=value},setMaterials:function(materials){this.materials=materials},parse:function(text){console.time("OBJLoader");var object,objects=[],foundObjects=!1,vertices=[],normals=[],uvs=[];function addObject(name){object={name:name,geometry:{vertices:[],normals:[],uvs:[]},material:{name:"",smooth:!0}},objects.push(object)}function parseVertexIndex(value){var index=parseInt(value);return 3*(index>=0?index-1:index+vertices.length/3)}function parseNormalIndex(value){var index=parseInt(value);return 3*(index>=0?index-1:index+normals.length/3)}function parseUVIndex(value){var index=parseInt(value);return 2*(index>=0?index-1:index+uvs.length/2)}function addVertex(a,b,c){object.geometry.vertices.push(vertices[a],vertices[a+1],vertices[a+2],vertices[b],vertices[b+1],vertices[b+2],vertices[c],vertices[c+1],vertices[c+2])}function addNormal(a,b,c){object.geometry.normals.push(normals[a],normals[a+1],normals[a+2],normals[b],normals[b+1],normals[b+2],normals[c],normals[c+1],normals[c+2])}function addUV(a,b,c){object.geometry.uvs.push(uvs[a],uvs[a+1],uvs[b],uvs[b+1],uvs[c],uvs[c+1])}function addFace(a,b,c,d,ua,ub,uc,ud,na,nb,nc,nd){var id,ia=parseVertexIndex(a),ib=parseVertexIndex(b),ic=parseVertexIndex(c);void 0===d?addVertex(ia,ib,ic):(addVertex(ia,ib,id=parseVertexIndex(d)),addVertex(ib,ic,id)),void 0!==ua&&(ia=parseUVIndex(ua),ib=parseUVIndex(ub),ic=parseUVIndex(uc),void 0===d?addUV(ia,ib,ic):(addUV(ia,ib,id=parseUVIndex(ud)),addUV(ib,ic,id))),void 0!==na&&(ia=parseNormalIndex(na),ib=parseNormalIndex(nb),ic=parseNormalIndex(nc),void 0===d?addNormal(ia,ib,ic):(addNormal(ia,ib,id=parseNormalIndex(nd)),addNormal(ib,ic,id)))}addObject("");for(var vertex_pattern=/^v\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,normal_pattern=/^vn\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,uv_pattern=/^vt\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,face_pattern1=/^f\s+(-?\d+)\s+(-?\d+)\s+(-?\d+)(?:\s+(-?\d+))?/,face_pattern2=/^f\s+((-?\d+)\/(-?\d+))\s+((-?\d+)\/(-?\d+))\s+((-?\d+)\/(-?\d+))(?:\s+((-?\d+)\/(-?\d+)))?/,face_pattern3=/^f\s+((-?\d+)\/(-?\d+)\/(-?\d+))\s+((-?\d+)\/(-?\d+)\/(-?\d+))\s+((-?\d+)\/(-?\d+)\/(-?\d+))(?:\s+((-?\d+)\/(-?\d+)\/(-?\d+)))?/,face_pattern4=/^f\s+((-?\d+)\/\/(-?\d+))\s+((-?\d+)\/\/(-?\d+))\s+((-?\d+)\/\/(-?\d+))(?:\s+((-?\d+)\/\/(-?\d+)))?/,object_pattern=/^[og]\s+(.+)/,smoothing_pattern=/^s\s+(\d+|on|off)/,lines=text.split("\n"),i=0;i<lines.length;i++){var result,line=lines[i];if(0!==(line=line.trim()).length&&"#"!==line.charAt(0))if(null!==(result=vertex_pattern.exec(line)))vertices.push(parseFloat(result[1]),parseFloat(result[2]),parseFloat(result[3]));else if(null!==(result=normal_pattern.exec(line)))normals.push(parseFloat(result[1]),parseFloat(result[2]),parseFloat(result[3]));else if(null!==(result=uv_pattern.exec(line)))uvs.push(parseFloat(result[1]),parseFloat(result[2]));else if(null!==(result=face_pattern1.exec(line)))addFace(result[1],result[2],result[3],result[4]);else if(null!==(result=face_pattern2.exec(line)))addFace(result[2],result[5],result[8],result[11],result[3],result[6],result[9],result[12]);else if(null!==(result=face_pattern3.exec(line)))addFace(result[2],result[6],result[10],result[14],result[3],result[7],result[11],result[15],result[4],result[8],result[12],result[16]);else if(null!==(result=face_pattern4.exec(line)))addFace(result[2],result[5],result[8],result[11],void 0,void 0,void 0,void 0,result[3],result[6],result[9],result[12]);else if(null!==(result=object_pattern.exec(line))){var name=result[1].trim();!1===foundObjects?(foundObjects=!0,object.name=name):addObject(name)}else if(/^usemtl /.test(line))object.material.name=line.substring(7).trim();else if(/^mtllib /.test(line));else{if(null===(result=smoothing_pattern.exec(line)))throw new Error("Unexpected line: "+line);object.material.smooth="1"===result[1]||"on"===result[1]}}for(var container=new Group,l=(i=0,objects.length);i<l;i++){var material,geometry=(object=objects[i]).geometry,buffergeometry=new BufferGeometry;buffergeometry.addAttribute("position",new BufferAttribute(new Float32Array(geometry.vertices),3)),geometry.normals.length>0?buffergeometry.addAttribute("normal",new BufferAttribute(new Float32Array(geometry.normals),3)):buffergeometry.computeVertexNormals(),geometry.uvs.length>0&&buffergeometry.addAttribute("uv",new BufferAttribute(new Float32Array(geometry.uvs),2)),null!==this.materials&&(material=this.materials.create(object.material.name)),material||((material=new MeshPhongMaterial).name=object.material.name),material.flatShading=!object.material.smooth;var mesh=new Mesh(buffergeometry,material);mesh.name=object.name,container.add(mesh)}return console.timeEnd("OBJLoader"),container}};var MTLLoader=function(manager){Object.assign(this,EventDispatcher.prototype),this.baseUrl="",this.manager=void 0!==manager?manager:DefaultLoadingManager};MTLLoader.prototype={constructor:MTLLoader,load:function(url,onLoad,onProgress,onError){var scope=this,loader=new FileLoader(this.manager);loader.setPath(this.path),loader.load(url,(function(text){onLoad(scope.parse(text))}),onProgress,onError)},setPath:function(value){this.path=value},setBaseUrl:function(value){this.baseUrl=value},setCrossOrigin:function(value){this.crossOrigin=value},setMaterialOptions:function(value){this.materialOptions=value},parse:function(text){for(var lines=text.split("\n"),info={},delimiter_pattern=/\s+/,materialsInfo={},i=0;i<lines.length;i++){var line=lines[i];if(0!==(line=line.trim()).length&&"#"!==line.charAt(0)){var pos=line.indexOf(" "),key=pos>=0?line.substring(0,pos):line;key=key.toLowerCase();var value=pos>=0?line.substring(pos+1):"";if(value=value.trim(),"newmtl"===key)info={name:value},materialsInfo[value]=info;else if(info)if("ka"===key||"kd"===key||"ks"===key){var ss=value.split(delimiter_pattern,3);info[key]=[parseFloat(ss[0]),parseFloat(ss[1]),parseFloat(ss[2])]}else info[key]=value}}var materialCreator=new MTLLoader.MaterialCreator(this.baseUrl,this.materialOptions);return materialCreator.setCrossOrigin(this.crossOrigin),materialCreator.setManager(this.manager),materialCreator.setMaterials(materialsInfo),materialCreator}},MTLLoader.MaterialCreator=function(baseUrl,options){this.baseUrl=baseUrl,this.options=options,this.materialsInfo={},this.materials={},this.materialsArray=[],this.nameLookup={},this.loader=void 0,this.side=this.options&&this.options.side?this.options.side:FrontSide,this.wrap=this.options&&this.options.wrap?this.options.wrap:RepeatWrapping},MTLLoader.MaterialCreator.prototype={constructor:MTLLoader.MaterialCreator,setCrossOrigin:function(value){this.crossOrigin=value},setManager:function(value){this.manager=value},setLoader:function(value){this.loader=value},setMaterials:function(materialsInfo){this.materialsInfo=this.convert(materialsInfo),this.materials={},this.materialsArray=[],this.nameLookup={}},convert:function(materialsInfo){if(!this.options)return materialsInfo;var converted={};for(var mn in materialsInfo){var mat=materialsInfo[mn],covmat={};for(var prop in converted[mn]=covmat,mat){var save=!0,value=mat[prop],lprop=prop.toLowerCase();switch(lprop){case"kd":case"ka":case"ks":this.options&&this.options.normalizeRGB&&(value=[value[0]/255,value[1]/255,value[2]/255]),this.options&&this.options.ignoreZeroRGBs&&0===value[0]&&0===value[1]&&0===value[1]&&(save=!1)}save&&(covmat[lprop]=value)}}return converted},preload:function(){for(var mn in this.materialsInfo)this.create(mn)},getIndex:function(materialName){return this.nameLookup[materialName]},getAsArray:function(){var index=0;for(var mn in this.materialsInfo)this.materialsArray[index]=this.create(mn),this.nameLookup[mn]=index,index++;return this.materialsArray},create:function(materialName){return void 0===this.materials[materialName]&&this.createMaterial_(materialName),this.materials[materialName]},createMaterial_:function(materialName){var mat=this.materialsInfo[materialName],params={name:materialName,side:this.side};for(var prop in mat){var value=mat[prop];if(""!==value)switch(prop.toLowerCase()){case"kd":params.color=(new Color).fromArray(value);break;case"ks":params.specular=(new Color).fromArray(value);break;case"map_kd":params.map=this.loadTexture(this.baseUrl+value),params.map.wrapS=this.wrap,params.map.wrapT=this.wrap;break;case"ns":params.shininess=parseFloat(value);break;case"d":(value<1||materialName.indexOf("_image")>0)&&(params.opacity=value,params.transparent=!0,params.alphaTest=.1);break;case"Tr":value>0&&(params.opacity=1-value,params.transparent=!0);break;case"map_bump":case"bump":if(params.bumpMap)break;params.bumpMap=this.loadTexture(this.baseUrl+value),params.bumpMap.wrapS=this.wrap,params.bumpMap.wrapT=this.wrap}}return this.materials[materialName]=new MeshPhongMaterial(params),this.materials[materialName]},loadTexture:function(url,mapping,onLoad,onProgress,onError){var texture,loader=Loader.Handlers.get(url),manager=void 0!==this.manager?this.manager:DefaultLoadingManager;return null===loader&&(loader=void 0!==this.loader?this.loader:new TextureLoader(manager)),loader.setCrossOrigin&&loader.setCrossOrigin(this.crossOrigin),texture=loader.load(url,onLoad,onProgress,onError),void 0!==mapping&&(texture.mapping=mapping),null!=texture&&(texture.anisotropy=16),texture}};var BASE_URL=/^https?:\/\/.*\//;var SceneLoader={load:function(obj,mtl,textureLoader){return new Promise((function(resolve,reject){var mtlLoader=new MTLLoader,match=BASE_URL.exec(mtl);if(null!=match){var baseUrl=match[0];mtlLoader.setBaseUrl(baseUrl),mtlLoader.setCrossOrigin("*")}mtlLoader.load(mtl,(function(materials){void 0!==textureLoader&&materials.setLoader(textureLoader),materials.preload();var objLoader=new OBJLoader;objLoader.setMaterials(materials),objLoader.load(obj,(function(container){container.children.forEach((function(child){null!=child.material&&(child.name.includes("_image")&&null!=child.material.map&&(child.material.map.wrapS=ClampToEdgeWrapping,child.material.map.wrapT=ClampToEdgeWrapping),child.material.side=DoubleSide)})),resolve(container)}),void 0,reject)}),void 0,reject)}))}};_export(_export.P,"Array",{fill:_arrayFill}),_addToUnscopables("fill");var _createProperty=function(object,index,value){index in object?_objectDp.f(object,index,_propertyDesc(0,value)):object[index]=value};_export(_export.S+_export.F*!_iterDetect((function(iter){Array.from(iter)})),"Array",{from:function(arrayLike){var length,result,step,iterator,O=_toObject(arrayLike),C="function"==typeof this?this:Array,aLen=arguments.length,mapfn=aLen>1?arguments[1]:void 0,mapping=void 0!==mapfn,index=0,iterFn=core_getIteratorMethod(O);if(mapping&&(mapfn=_ctx(mapfn,aLen>2?arguments[2]:void 0,2)),null==iterFn||C==Array&&_isArrayIter(iterFn))for(result=new C(length=_toLength(O.length));length>index;index++)_createProperty(result,index,mapping?mapfn(O[index],index):O[index]);else for(iterator=iterFn.call(O),result=new C;!(step=iterator.next()).done;index++)_createProperty(result,index,mapping?_iterCall(iterator,mapfn,[step.value,index],!0):step.value);return result.length=index,result}});var $at=_stringAt(!0);_iterDefine(String,"String",(function(iterated){this._t=String(iterated),this._i=0}),(function(){var point,O=this._t,index=this._i;return index>=O.length?{value:void 0,done:!0}:(point=$at(O,index),this._i+=point.length,{value:point,done:!1})}));var _validateCollection=function(it,TYPE){if(!_isObject(it)||it._t!==TYPE)throw TypeError("Incompatible receiver, "+TYPE+" required!");return it},dP$4=_objectDp.f,fastKey=_meta.fastKey,SIZE=_descriptors?"_s":"size",getEntry=function(that,key){var entry,index=fastKey(key);if("F"!==index)return that._i[index];for(entry=that._f;entry;entry=entry.n)if(entry.k==key)return entry},_collectionStrong={getConstructor:function(wrapper,NAME,IS_MAP,ADDER){var C=wrapper((function(that,iterable){_anInstance(that,C,NAME,"_i"),that._t=NAME,that._i=_objectCreate(null),that._f=void 0,that._l=void 0,that[SIZE]=0,null!=iterable&&_forOf(iterable,IS_MAP,that[ADDER],that)}));return _redefineAll(C.prototype,{clear:function(){for(var that=_validateCollection(this,NAME),data=that._i,entry=that._f;entry;entry=entry.n)entry.r=!0,entry.p&&(entry.p=entry.p.n=void 0),delete data[entry.i];that._f=that._l=void 0,that[SIZE]=0},delete:function(key){var that=_validateCollection(this,NAME),entry=getEntry(that,key);if(entry){var next=entry.n,prev=entry.p;delete that._i[entry.i],entry.r=!0,prev&&(prev.n=next),next&&(next.p=prev),that._f==entry&&(that._f=next),that._l==entry&&(that._l=prev),that[SIZE]--}return!!entry},forEach:function(callbackfn){_validateCollection(this,NAME);for(var entry,f=_ctx(callbackfn,arguments.length>1?arguments[1]:void 0,3);entry=entry?entry.n:this._f;)for(f(entry.v,entry.k,this);entry&&entry.r;)entry=entry.p},has:function(key){return!!getEntry(_validateCollection(this,NAME),key)}}),_descriptors&&dP$4(C.prototype,"size",{get:function(){return _validateCollection(this,NAME)[SIZE]}}),C},def:function(that,key,value){var prev,index,entry=getEntry(that,key);return entry?entry.v=value:(that._l=entry={i:index=fastKey(key,!0),k:key,v:value,p:prev=that._l,n:void 0,r:!1},that._f||(that._f=entry),prev&&(prev.n=entry),that[SIZE]++,"F"!==index&&(that._i[index]=entry)),that},getEntry:getEntry,setStrong:function(C,NAME,IS_MAP){_iterDefine(C,NAME,(function(iterated,kind){this._t=_validateCollection(iterated,NAME),this._k=kind,this._l=void 0}),(function(){for(var kind=this._k,entry=this._l;entry&&entry.r;)entry=entry.p;return this._t&&(this._l=entry=entry?entry.n:this._t._f)?_iterStep(0,"keys"==kind?entry.k:"values"==kind?entry.v:[entry.k,entry.v]):(this._t=void 0,_iterStep(1))}),IS_MAP?"entries":"values",!IS_MAP,!0),_setSpecies(NAME)}},_collection=function(NAME,wrapper,methods,common,IS_MAP,IS_WEAK){var Base=_global[NAME],C=Base,ADDER=IS_MAP?"set":"add",proto=C&&C.prototype,O={},fixMethod=function(KEY){var fn=proto[KEY];_redefine(proto,KEY,"delete"==KEY?function(a){return!(IS_WEAK&&!_isObject(a))&&fn.call(this,0===a?0:a)}:"has"==KEY?function(a){return!(IS_WEAK&&!_isObject(a))&&fn.call(this,0===a?0:a)}:"get"==KEY?function(a){return IS_WEAK&&!_isObject(a)?void 0:fn.call(this,0===a?0:a)}:"add"==KEY?function(a){return fn.call(this,0===a?0:a),this}:function(a,b){return fn.call(this,0===a?0:a,b),this})};if("function"==typeof C&&(IS_WEAK||proto.forEach&&!_fails((function(){(new C).entries().next()})))){var instance=new C,HASNT_CHAINING=instance[ADDER](IS_WEAK?{}:-0,1)!=instance,THROWS_ON_PRIMITIVES=_fails((function(){instance.has(1)})),ACCEPT_ITERABLES=_iterDetect((function(iter){new C(iter)})),BUGGY_ZERO=!IS_WEAK&&_fails((function(){for(var $instance=new C,index=5;index--;)$instance[ADDER](index,index);return!$instance.has(-0)}));ACCEPT_ITERABLES||((C=wrapper((function(target,iterable){_anInstance(target,C,NAME);var that=_inheritIfRequired(new Base,target,C);return null!=iterable&&_forOf(iterable,IS_MAP,that[ADDER],that),that}))).prototype=proto,proto.constructor=C),(THROWS_ON_PRIMITIVES||BUGGY_ZERO)&&(fixMethod("delete"),fixMethod("has"),IS_MAP&&fixMethod("get")),(BUGGY_ZERO||HASNT_CHAINING)&&fixMethod(ADDER),IS_WEAK&&proto.clear&&delete proto.clear}else C=common.getConstructor(wrapper,NAME,IS_MAP,ADDER),_redefineAll(C.prototype,methods),_meta.NEED=!0;return _setToStringTag(C,NAME),O[NAME]=C,_export(_export.G+_export.W+_export.F*(C!=Base),O),IS_WEAK||common.setStrong(C,NAME,IS_MAP),C},COLLISION_RANKING_TIERS=(_collection("Set",(function(get){return function(){return get(this,arguments.length>0?arguments[0]:void 0)}}),{add:function(value){return _collectionStrong.def(_validateCollection(this,"Set"),value=0===value?0:value,value)}},_collectionStrong),{OPTIONAL_MINIMUM:0,OPTIONAL_MAXIMUM:1,MEDIUM:2,HIGH:3});_collection("Map",(function(get){return function(){return get(this,arguments.length>0?arguments[0]:void 0)}}),{get:function(key){var entry=_collectionStrong.getEntry(_validateCollection(this,"Map"),key);return entry&&entry.v},set:function(key,value){return _collectionStrong.def(_validateCollection(this,"Map"),0===key?0:key,value)}},_collectionStrong,!0);_descriptors&&"g"!=/./g.flags&&_objectDp.f(RegExp.prototype,"flags",{configurable:!0,get:_flags});var $toString=/./.toString,define=function(fn){_redefine(RegExp.prototype,"toString",fn,!0)};_fails((function(){return"/a/b"!=$toString.call({source:"a",flags:"b"})}))?define((function(){var R=_anObject(this);return"/".concat(R.source,"/","flags"in R?R.flags:!_descriptors&&R instanceof RegExp?_flags.call(R):void 0)})):"toString"!=$toString.name&&define((function(){return $toString.call(this)}));var DEFAULT_LABEL_SIZING={MARGIN:2,HEIGHT_MARGIN:.5,SIZE:1.2},mode=null,loadMapViewByMode=function(do3D){mode=do3D?modes["3D"]:modes["2D"]},force2D=function(callback){mode=modes["2D"],callback&&callback()},force3D=function(callback){mode=modes["3D"],callback&&callback()},forceTest$1=function(container,callback){return forceTest(0,callback,loadMapViewByMode)},test3D$1=function(container,callback){return function(container,callback,loadMapViewByMode){try{var savedResults=window.localStorage.getItem(TEST_KEY);if(null!=savedResults)return loadMapViewByMode&&loadMapViewByMode("true"==savedResults),callback(null,"true"==savedResults,null)}catch(e){}return forceTest(container,callback,loadMapViewByMode)}(container,callback,loadMapViewByMode)},getVenue$2=function(options,callback){return getVenue$1(options,mode,callback)};export{Analytics,BlueDot,COLLISION_RANKING_TIERS,DEFAULT_LABEL_SIZING,SceneLoader,Search,force2D,force3D,forceTest$1 as forceTest,getObjectId,getVenue$2 as getVenue,test3D$1 as test3D};
